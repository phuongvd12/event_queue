/*
 * Init_Meter.c
 *
 *  Created on: Dec 15, 2015
 *      Author: Administrator
 */

#include "variable.h"
#include "Elster_Init_Meter.h"
#include "Elster_Read_Meter.h"
#include "t_mqtt.h"
#include "sim900.h"
#include "pushdata.h"
/*======================== Init Structs ======================*/

Meter_Comm_Struct				Meter_Handshake;
void Init_Meter_Handshake (void)
{
	Meter_Handshake.Step_ui8 = 0;
	Meter_Handshake.Error_ui8 = 0;
	Meter_Handshake.Total_Mess_Sent_ui32 = 0;
	Meter_Handshake.Success_Read_Mess_ui32 = 0;
	Meter_Handshake.Error_Meter_Norespond_ui32 = 0;
	Meter_Handshake.Error_Wrong_Mess_Format_ui32 = 0;
}

//=======================================Constant & Template===========================================
const	uint8_t	Decode_Password_Table[16] = {0x30,0xB1,0xB2,0x33,0xB4,0x35,0x36,0xB7,
											 0xB8,0x39,0x41,0x42,0xC3,0x44,0xC5,0xC6};

uint8_t MeterRawData[64];
uint8_t	ELSTER_END[5] = {0x81,0x42,0x30,0x03,0x71};
uint8_t	ELSTER_Handshake1[5] = {0xAF,0x3F,0x21,0x8D,0x0A};
uint8_t	ELSTER_Handshake2[6] = {0x06,0x30,0x35,0xB1,0x8D,0x0A};
uint8_t	ELSTER_Handshake3[24] = {0x81,0x50,0xB2,0x82,0x28,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA9,0x03,0x00};
uint8_t	ELSTER_Hs_inbuff[16] = {0x42,0x36,0x36,0x42,0xB7,0x41,0xB8,0xB2,0xB4,0xC3,0xB8,0x39,0xC5,0x36,0x42,0x41};
uint8_t	ELSTER_Hs_outbuff[16];

uint8_t ELSTER_Get_MID[16] = {0x81,0xD2,0xB1,0x82,0xB7,0x39,0xB8,0x30,0x30,0xB1,0x28,0xB1,0x30,0xA9,0x03,0x65};

//Meter info
uint8_t ELSTER_MInfo_Table[17][23] = 
{
	{0x81,0xD2,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0x30,0xB4,0xA9,0x03,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x10},
	{0x81,0xD2,0xB1,0x82,0x36,0x30,0x36,0x30,0x30,0xB1,0x28,0xB1,0xC3,0xA9,0x03,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x10},
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0x42,0xB2,0x42,0xB4,0x42,0x30,0x30,0xA9,0x03,0x11,0x16},//VoltagePhaseA,B,C
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0x41,0xB2,0x41,0xB4,0x41,0x30,0x30,0xA9,0x03,0x12,0x16},//CurrentPhaseA,B,C
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0xB8,0xB2,0xB8,0xB4,0xB8,0x30,0x30,0xA9,0x03,0xEB,0x16},//FrequencyPhaseA,B,C
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0x39,0xB2,0x39,0xB4,0x39,0x30,0x30,0xA9,0x03,0x6A,0x16},//PhaseAnglePhaseA,B,C
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0xC3,0xB2,0xC3,0xB4,0xC3,0x30,0xC3,0xA9,0x03,0x63,0x16},//ActivePowerPhaseA,B,C,Total
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0x44,0xB2,0x44,0xB4,0x44,0x30,0x44,0xA9,0x03,0x63,0x16},//ReactivePowerPhaseA,B,C,Total
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0xC5,0xB2,0xC5,0xB4,0xC5,0x30,0xC5,0xA9,0x03,0x63,0x16},//ApparentPowerPhaseA,B,C,Total
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0xB1,0x33,0xB2,0x33,0xB4,0x33,0x30,0x33,0xA9,0x03,0x63,0x16},//PowerFactorPhaseA,B,C,Total
	{0x81,0xD7,0xB1,0x82,0x36,0x30,0x35,0x30,0x30,0xB1,0x28,0x30,0xB7,0x30,0x30,0x30,0x30,0x30,0x30,0xA9,0x03,0x63,0x16},//PhaseRotation
	{0x81,0xD2,0xB1,0x82,0x35,0x30,0xB7,0x30,0x30,0xB1,0x28,0xB4,0x30,0xA9,0x03,0xE4,0x00,0x00,0x00,0x00,0x00,0x00,0x10},//Cumulative,0xTotal:,0xImportWh,ExportWh,Q1,Q2,Q3,Q4,Vah
	{0x81,0xD2,0xB1,0x82,0x35,0x30,0xB8,0x30,0x30,0xB1,0x28,0xB4,0x30,0xA9,0x03,0xEB,0x00,0x00,0x00,0x00,0x00,0x00,0x10},//EnergyPlusArate1-3,EnergySubArate1-3
	{0x81,0xD2,0xB1,0x82,0x35,0xB1,0x30,0x30,0x30,0xB1,0x28,0xB4,0x30,0xA9,0x03,0xE2,0x00,0x00,0x00,0x00,0x00,0x00,0x10},//MaxDemandPlusARate13-Time
	{0x81,0xD2,0xB1,0x82,0x36,0xB1,0xB4,0x30,0x30,0xB1,0x28,0x30,0xB7,0xA9,0x03,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x10},//Tu-TuM
	{0x81,0xD2,0xB1,0x82,0x36,0xB1,0x36,0x30,0x30,0xB1,0x28,0x30,0x36,0xA9,0x03,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x10},//Ti-TiM
	{0x81,0xD2,0xB1,0x82,0xB8,0x36,0xB1,0x30,0x30,0xB1,0x28,0x30,0xB7,0xA9,0x03,0x6A,0x00,0x00,0x00,0x00,0x00,0x00,0x10} //MeterTime
	
};
uint8_t	ELSTER_MeterInfoMessIDTable[61] = { 2, 0, 0, 0, 0, 1, 3, 0, 0, 0, 0, 1, 4, 0, 0, 0, 0, 1, 5, 0, 0, 0, 0, 1, 6, 0, 0, 0, 0, 1, 7, 0, 0, 0, 0, 1, 8, 0, 0, 0, 0, 1, 9, 0, 0, 0, 0, 1, 10, 0, 0, 0, 0, 1, 11,12,13,14,15,16,0xFF};
					  //MessStep	 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  50 51 52 53 54  55 56 57 58 59 60

uint8_t	ELSTER_MeterTuTiIDTable[3] = {14,15,0xFF};
	

//Meter billing
uint8_t ELSTER_MBilling_Table[5] = {0x30,0xB1,0x28,0xB4,0x30};    //{0x30,0xC5,0x28,0xB1,0xC6},
	
uint8_t	ELSTER_MeterBillingMessIDTable[16];    //14 lan doc trong 1 bill //k doc qua 1 nam
uint8_t ELSTER_MeterBillingTemplate[16] = {0x81,0xD2,0xB1,0x82,0x35,0xB4,0x33,0x30,0x00,0x00,0x00,0x00,0x00,0xA9,0x03,0x00};

//Meter event
uint8_t ELSTER_MEvent_Table[12][16] = 
{
	{0x81,0xD2,0xB1,0x82,0x36,0xB8,0x30,0x30,0x30,0xB1,0x28,0xB1,0x36,0xA9,0x03,0xEB},//ProgrammingLog
	{0x81,0xD2,0xB1,0x82,0xB7,0x30,0x30,0x30,0x30,0xB1,0x28,0xB1,0x36,0xA9,0x03,0xE2},//PasswordChange
	{0x81,0xD2,0xB1,0x82,0xB4,0x35,0x35,0x30,0x30,0xB1,0x28,0xB2,0xC5,0xA9,0x03,0x11},//VoltageImbalance
	{0x81,0xD2,0xB1,0x82,0xB7,0x30,0xB1,0x30,0x30,0xB1,0x28,0xB2,0xC5,0xA9,0x03,0x93},//PowerFailure
	{0x81,0xD2,0xB1,0x82,0xB7,0x30,0xB2,0x30,0x30,0xB1,0x28,0xB2,0xC5,0xA9,0x03,0x90},//Time/DateChange
	{0x81,0xD2,0xB1,0x82,0x36,0x39,0x33,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x1B},//PhaseFailure
	{0x81,0xD2,0xB1,0x82,0xB7,0xB4,0xB2,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x96},//ReverseRun
	{0x81,0xD2,0xB1,0x82,0xB7,0x35,0x35,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x90},//ReadInstEvent1
	{0x81,0xD2,0xB1,0x82,0xB7,0x35,0x36,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x93},//ReadInstEvent2
	{0x81,0xD2,0xB1,0x82,0xB7,0x35,0xB7,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x12},//ReadInstEvent3
	{0x81,0xD2,0xB1,0x82,0xB7,0x35,0xB8,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x1D},//ReadInstEvent4
	{0x81,0xD2,0xB1,0x82,0xB7,0x35,0x39,0x30,0x30,0xB1,0x28,0x33,0xC6,0xA9,0x03,0x9C} //ReadInstEvent5
};

uint8_t	ELSTER_MeterEventMessIDTable[13] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,0xFF};
uint8_t	ME_ObisOderStart[5];
uint8_t	ME_ObisOderEnd[5];

//Meter loadprofile
uint8_t RMLP_First_Mess[18] = {0x81,0xD7,0xB1,0x82,0x35,0x35,0xB1,0x30,0x30,0xB1,0x28,0x00,0x00,0x00,0x00,0xA9,0x03,0x00};
uint8_t RMLP_Second_Mess[16] = {0x81,0xD2,0xB1,0x82,0x35,0x35,0xB1,0x30,0x30,0xB1,0x28,0x30,0xB2,0xA9,0x03,0xE1};
uint8_t RMLP_GetData_Mess[16] = {0x81,0xD2,0xB1,0x82,0x35,0x35,0x00,0x00,0x00,0x00,0x28,0xB4,0x30,0xA9,0x03,0x00};
uint8_t	MeterLProfMessIDTable[20] = {0x00,0x00,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0xFF,};
uint16_t	RMLP_NumDay = 2;
uint16_t	ToTal_PackLpf = 2;
uint16_t	Bill_NumDay = 1;

uint8_t aLoadprofileDataPeriod[11] = {1, 2, 3, 4, 5, 6, 10, 15, 20, 30, 60};

uint8_t password[8] = {0x4D,0x5F,0x4B,0x48,0x5F,0x44,0x4F,0x43};				// M_KH_DOC
uint8_t password_backup[8] = {0x46,0x45,0x44,0x43,0x30,0x30,0x30,0x33};				// FEDC00030


Struct_ObisEvent  Elster_Ob_Event[MAX_OBIS_EVENT]=
{
    { 0x19,     &Ev_ChangeTime_Count},   //count time change
    { 0x1B,     &Ev_ChangeTime_Startt},   //Start time change
    
    { 0x07,     &Ev_PhaseAfail_Count},    //pha a fail start count
    { 0x08,     &Ev_PhaseBfail_Count},
    { 0x09,     &Ev_PhaseCfail_Count},
    
    { 0x0D,     &Ev_PhaseAfail_Startt},    //pha a fail start time 0x0D,0x0E,0x0F,0x10,0x11,0x12
    { 0x10,     &Ev_PhaseAfail_Stopt},
    { 0x0E,     &Ev_PhaseBfail_Startt},
    { 0x11,     &Ev_PhaseBfail_Stopt},    
    { 0x0F,     &Ev_PhaseCfail_Startt},
    { 0x12,     &Ev_PhaseCfail_Stopt},
    
    { 0x1D,     &Ev_PhaseAreve_Count},    //pha a reverse start count
    { 0x1E,     &Ev_PhaseBreve_Count},
    { 0x1F,     &Ev_PhaseCreve_Count},
    
    { 0x23,     &Ev_PhaseAreve_Startt},    //pha a reverse start time 0x23,0x24,0x25,0x26,0x27,0x28
    { 0x26,     &Ev_PhaseAreve_Stopt},
    { 0x24,     &Ev_PhaseBreve_Startt},
    { 0x27,     &Ev_PhaseBreve_Stopt},    
    { 0x25,     &Ev_PhaseCreve_Startt},
    { 0x28,     &Ev_PhaseCreve_Stopt},
};







