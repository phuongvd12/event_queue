#include "stm32f3xx_hal.h"
#include "stm32f3xx.h"
#include "math.h"

#include "usart.h"
#include "CPC_Init_Meter.h"
#include "CPC_Read_Meter.h"


#include "variable.h"
#include "sim900.h"
#include "t_mqtt.h"
#include "myuart.h"
#include "pushdata.h"
#include "rtc.h"
#include "onchipflash.h"
#include "at_commands.h"


uint8_t 							aTempBuff_Cmd[256] = {0};   //buff chua byte gui lenh
uint8_t 							Buff_ACK[] = {'/', 'X', 'X', 'X'};   //Bat dau cua ACK 1 tu cong to ra
truct_String						Str_ACK ={(uint8_t*) &Buff_ACK[0], 4};
uint8_t 							Buff_RECEI_KEY[] = {SOH, 'P', '0', STX};   //Bat dau cua ACK 1 tu cong to ra
truct_String						Str_RECEI_KEY ={(uint8_t*) &Buff_RECEI_KEY[0], 4};

Meter_Var_Struct					Met_Var;

uint8_t 							BuffStringOutStation[MAX_LENGTH_OUTS];
Struct_LastBill						LastBill;

/*----------------Function-----------------*/
//Function send cmd theo chuan IEC62056_21

void CPC_IEC62056_21_Command (uint8_t Kind_Cmd, uint8_t* BuffSend, uint16_t lengthSend)
{
	uint8_t i=0;
	uint8_t length = 0;
	uint8_t Temp_BBC = 0;
	
	switch(Kind_Cmd)
	{
		case CMD_HANDSHAKE:
			for(i = 0; i< sizeof(CPC_Handshake1); i++)
			{	
				aTempBuff_Cmd[i] = CPC_Handshake1[i];
				length++;
			}
			break;
		case CMD_ACK: 
			for(i = 0; i< sizeof(CPC_Handshake2); i++)
			{	
				aTempBuff_Cmd[i] = CPC_Handshake2[i];
				length++;
			}
			break;
		case CMD_SEND_PASS: 
			aTempBuff_Cmd[length++] = SOH;
			aTempBuff_Cmd[length++] = 'P';
			aTempBuff_Cmd[length++] = '2';
			aTempBuff_Cmd[length++] = STX;
			for(i = 0; i< lengthSend; i++)
			{	
				aTempBuff_Cmd[length++] = *(BuffSend + i);
			}
			aTempBuff_Cmd[length++] = ETX;
			//them BBC vao
			Temp_BBC = BBC_Cacul(&aTempBuff_Cmd[1], (length-1));    //lenh nay BBC bang Xor tu 'P' cho den ETX
			aTempBuff_Cmd[length++] = Temp_BBC;
			break;  
		case CMD_READ: 
			aTempBuff_Cmd[length++] = SOH;
			aTempBuff_Cmd[length++] = 'R';
			aTempBuff_Cmd[length++] = '1';
			aTempBuff_Cmd[length++] = STX;
			for(i = 0; i< lengthSend; i++)
			{	
				aTempBuff_Cmd[length++] = *(BuffSend + i);
			}
			aTempBuff_Cmd[length++] = ETX;
			//them BBC vao
			Temp_BBC = BBC_Cacul(&aTempBuff_Cmd[1], (length-1));    //lenh nay BBC bang Xor tu 'P' cho den ETX
			aTempBuff_Cmd[length++] = Temp_BBC;
			break; 
		case CMD_WRITE: 
			aTempBuff_Cmd[length++] = SOH;
			aTempBuff_Cmd[length++] = 'W';
			aTempBuff_Cmd[length++] = '1';
			aTempBuff_Cmd[length++] = STX;
			for(i = 0; i< lengthSend; i++)
			{	
				aTempBuff_Cmd[length++] = *(BuffSend + i);
			}
			aTempBuff_Cmd[length++] = ETX;
			//them BBC vao
			Temp_BBC = BBC_Cacul(&aTempBuff_Cmd[1], (length-1));    //lenh nay BBC bang Xor tu 'P' cho den ETX
			aTempBuff_Cmd[length++] = Temp_BBC;
			break; 
			
		case CMD_LOGOUT:   
			// SOH B0 STX () ETX BCC
			aTempBuff_Cmd[length++] = SOH;
			aTempBuff_Cmd[length++] = 'B';
			aTempBuff_Cmd[length++] = '0';
			aTempBuff_Cmd[length++] = STX;
			aTempBuff_Cmd[length++] = '(';
			aTempBuff_Cmd[length++] = ')';
			aTempBuff_Cmd[length++] = ETX;
			//them BBC vao
			Temp_BBC = BBC_Cacul(&aTempBuff_Cmd[1], (length-1));    //lenh nay BBC bang Xor tu 'P' cho den ETX
			aTempBuff_Cmd[length++] = Temp_BBC;
			
		default: 
			break;
	}
	HAL_UART_Transmit(&huart1,&aTempBuff_Cmd[0], length, 1000);
}



void CPC_Init_Function (uint8_t type)
{
    eMeter_20._f_Read_ID            = CPC_Get_Meter_ID;
    eMeter_20._f_Check_Reset_Meter  = CPC_CheckResetReadMeter;
  
    eMeter_20._f_Connect_Meter      = CPC_Connect_Metter_Handle;
    eMeter_20._f_Read_TSVH          = CPC_Read_TSVH;
    eMeter_20._f_Read_Intan         = CPC_Read_Intan;
    eMeter_20._f_Read_Bill          = CPC_Read_Bill;
    eMeter_20._f_Read_Event         = CPC_Read_Event;  
    eMeter_20._f_Read_Lpf           = CPC_Read_Lpf;
    eMeter_20._f_Read_InforMeter    = CPC_Read_Infor;
    eMeter_20._f_Get_UartData       = CPC_GetUART1Data;
    eMeter_20._f_Check_Meter        = CPC_Check_Meter;
}


uint8_t CPC_Read_TSVH (void)
{
    Init_Meter_Info_Struct();
    Met_Var.Flag_GetIntan_Ok = 0;
    Met_Var.Flag_Get_Tariff_Ok = 0;
    Met_Var.Flag_Get_MaxDemand_Ok = 0;
    Met_Var.Flag_Get_EnRegister_Ok = 0;
    return Read_TSVH_CPC(&Pack_PushData_103_Opera_1, DATA_OPERATION);
}
uint8_t CPC_Read_Intan (void)
{
    Init_Meter_Info_Struct();
    Met_Var.Flag_GetIntan_Ok = 0;
    Met_Var.Flag_Get_Tariff_Ok = 0;
    Met_Var.Flag_Get_MaxDemand_Ok = 0;
    Met_Var.Flag_Get_EnRegister_Ok = 0;
    
    return Read_TSVH_CPC(&Pack_PushData_103_Opera_1, DATA_INTANTANIOUS);
    
}
uint8_t CPC_Read_Bill (void)
{
    uint8_t result = 0;
    
    result = Read_Historycal_CPC(sInformation.IndexStartBill, sInformation.IndexEndBill);
    sInformation.Flag_Stop_ReadBill = 0;   //Reset lai Flag
    return result;
}
uint8_t CPC_Read_Event (uint32_t TemValue)
{
    Init_Meter_Event_Struct();
    return CPC_ReadMeter_Event();
}
uint8_t CPC_Read_Lpf (void)
{
    uint8_t result = 0;
    
    if(sInformation.Flag_Request_lpf == 1)
    {
        result = Read_Lpf_CPC(sInformation.IndexStartLpf, sInformation.IndexEndLpf, 1);
        sInformation.Flag_Request_lpf = 0;
    }else 
      result = Read_Lpf_CPC(2, 2,  1);   //luc 0h32p doc lpf doc Index ngay hom truoc
    
    return result;
}
uint8_t CPC_Read_Infor (void)
{
    return Read_Infor_Meter();
}


 
uint8_t CPC_Connect_Metter_Handle(void)
{
	uint8_t ReadIDRetry = 1; // qua 1 lan la bi loi khi sang mat khau moi - chi doc 1 lan
	
	__HAL_UART_ENABLE_IT(&huart1, UART_IT_RXNE);
	
	while (ReadIDRetry>0)
	{
        osDelay(500);
        if (osMutexWait(mtFlashMeterHandle,1000) == osOK)
		{
            Read_Meter_ID_Success = CPC_Get_Meter_ID(0);
            
            if (osMutexRelease(mtFlashMeterHandle) != osOK)
                osMutexRelease(mtFlashMeterHandle);
            if (Read_Meter_ID_Success == 1)
                break;
            else
                osDelay(TIME_DELAY_ERR);
            ReadIDRetry--;
        }
	}
	if (Read_Meter_ID_Success == 0)   //Reinit uart1  /**** Check lai o day xem con loi khong ***/
	{
		huart1.Instance = USART1;
		huart1.Init.BaudRate = UART2_BAUR_2;
		huart1.Init.WordLength = UART2_DATALENGTH;
		huart1.Init.StopBits = UART_STOPBITS_1;
		huart1.Init.Parity = UART_PARITY_EVEN;
		huart1.Init.Mode = UART_MODE_TX_RX;
		huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
		huart1.Init.OverSampling = UART_OVERSAMPLING_16;
		huart1.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE ;
		huart1.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
		HAL_UART_Init(&huart1);
		//
		__HAL_UART_ENABLE_IT(&huart1, UART_IT_RXNE);
		osDelay(TIME_DELAY_ERR);
		
		ReadIDRetry = 1;
		
		while (ReadIDRetry>0)
        {
            osDelay(500);
            if (osMutexWait(mtFlashMeterHandle,1000) == osOK)
            {
                Read_Meter_ID_Success = CPC_Get_Meter_ID(0);
                
                if (osMutexRelease(mtFlashMeterHandle) != osOK)
                    osMutexRelease(mtFlashMeterHandle);
                if (Read_Meter_ID_Success == 1)
                    break;
                else
                    osDelay(TIME_DELAY_ERR);
                ReadIDRetry--;
            }
        }
	}
    if(Read_Meter_ID_Success == 1) return 1;
    else return 0;
}


//
//uint8_t CPC_Detect_Meter(void)
//{
//    __HAL_UART_ENABLE_IT(&huart1, UART_IT_RXNE);
//    
//    if (CPC_Handshake_Handle() != 1)
//    {   
//        huart1.Instance = USART1;
//		huart1.Init.BaudRate = UART2_BAUR_2;
//		huart1.Init.WordLength = UART2_DATALENGTH;
//		huart1.Init.StopBits = UART_STOPBITS_1;
//		huart1.Init.Parity = UART_PARITY_EVEN;
//		huart1.Init.Mode = UART_MODE_TX_RX;
//		huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
//		huart1.Init.OverSampling = UART_OVERSAMPLING_16;
//		huart1.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE ;
//		huart1.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
//		HAL_UART_Init(&huart1);
//		//
//		__HAL_UART_ENABLE_IT(&huart1, UART_IT_RXNE);
//        
//        if (CPC_Handshake_Handle() == 1) return 1;
//        else return 0;
//    }
//    
//    return 1;
//}

uint8_t CPC_Get_Meter_ID (uint32_t TempValue)
{
	uint8_t GetMeterIDRetry = 3;
	uint8_t Data_Set_ID[11] = {'0', '(', '0', '0', '0', '0', '0', '0', '0', '0', ')'}; // 11byte: 0(00000000)
    uint8_t i = 0;
    uint16_t length = 0;
    uint8_t ByteTemp = 0;
    uint8_t Buff_ID_Temp[METER_LENGTH];
    
	while (GetMeterIDRetry--)
	{
		if (CPC_Handshake_Handle() == 1)
		{
//			HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nRead ID meter\r\n", 17, 1000);
			UART1_Control.Mode_ui8 = 0;    //chuyen uart sang nhan data
			Reset_UART1_State();
			//Send Read ID
			CPC_IEC62056_21_Command (CMD_READ, &Data_Set_ID[0], 11);
            
			if (osSemaphoreWait(bsUART2PendingMessHandle,5000) == osOK) 
            {
				//Check BBC
				if(CPC_Check_Sum(&UART1_Control.UART1_Str_Recei) == 1)
				{
                    Met_Var.MeterID = 0;
					//cat ID meter o day
                    if(*(UART1_Control.UART1_Str_Recei.Data_a8 + 1) == Data_Set_ID[0])  //
                    {
                        for(i = 0; i < 4; i++)
                        {
                            ByteTemp = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
                            length += 2;
                            Met_Var.MeterID |= (ByteTemp << (8*i));
                        }     
                        //Convert sang Struct string va luu vao FLash
                        sDCU.sMeter_id_Read.Data_a8 = &Buff_ID_Temp[0];
                        Reset_Buff(&sDCU.sMeter_id_Read);
                        Pack_HEXData_Frame(&sDCU.sMeter_id_Read,  Met_Var.MeterID, 0); 
                        
                        if (sDCU.sMeter_id_now.Length_u16 != sDCU.sMeter_id_Read.Length_u16)
                            Read_Meter_ID_Change = 1;
                        else
                        {
                            for (i=0; i<sDCU.sMeter_id_Read.Length_u16 ;i++)
                            {
                                if ((*(sDCU.sMeter_id_now.Data_a8+i)) != (*(sDCU.sMeter_id_Read.Data_a8+i)))
                                {
                                    Read_Meter_ID_Change = 1;
                                    break;
                                }
                            }
                        }
                    
                        if(Read_Meter_ID_Change == 1)
                        {
                            Reset_Buff(&sDCU.sMeter_id_now);
                            Pack_HEXData_Frame(&sDCU.sMeter_id_now,  Met_Var.MeterID, 0); 
                            Save_Meter_ID();
                        }
                          
//                        HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nRead ID OK\r\n", 14, 1000);
                        return 1;
                    }
				}
				else
				{
//					HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nRead ID Fail\r\n", 16, 1000);
					Reset_UART1_State();
					CPC_IEC62056_21_Command (CMD_LOGOUT, NULL, 0);
					osDelay(TIME_DELAY_ERR);
				}
			}
			else
			{
				Reset_UART1_State();
				CPC_IEC62056_21_Command (CMD_LOGOUT, NULL, 0);
				osDelay(TIME_DELAY_ERR);
//				HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nRead ID Fail\r\n", 16, 1000);
			}
		}
//		HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nRetry Connect Meter\r\n", 23, 1000);
	}
	return 0;
}



void Reset_UART1_State (void)
{
	Init_Point_Buffer(&UART1_Control.UART1_Str_Recei, UART1_Receive_Buff);
	UART1_Control.Mess_Pending_ui8 = 0;
	UART1_Control.Flag_Have_0x02  = 0;
}

void Init_Point_Buffer (truct_String* Str_Point, uint8_t* Buff)
{
	Str_Point->Data_a8 = Buff;
	Reset_Buff(Str_Point);
	Str_Point->Length_u16 = 0;
}

uint8_t CPC_Handshake_Handle (void)
{
	Reset_UART1_State();
	Met_Var.Step_HandShake = STEP_END;   	   
	uint8_t i = 0;
    int	PosFind = 0;
	uint8_t Count_Step_End = 0;
	UART1_Control.Mode_ui8 = 1;
	Met_Var.Reading_ui8 = 0;
	
	while (Met_Var.Reading_ui8 == 0)     
	{
		switch (Met_Var.Step_HandShake)
		{
			case SEND_FIRST_CHAR:	//Send first Char  
//				HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nSend First Char\r\n", 19, 1000);
				Met_Var.Step_HandShake++;
				//Send First Char cmd
				CPC_IEC62056_21_Command (CMD_HANDSHAKE, NULL, 0);
				break;
			case CHECK_ACK_1:   //check ACK 1 tu cong to ra
				if (osSemaphoreWait(bsUART2PendingMessHandle,5000) == osOK) 
                {
                    Met_Var.Step_HandShake++;
					//Check chuoi nhan ve
					if(UART1_Control.UART1_Str_Recei.Length_u16 < 5) return 0;
					
					if(Find_String_V2(&Str_ACK, &UART1_Control.UART1_Str_Recei) >= 0)
					{
						Reset_UART1_State();
					}else Met_Var.Step_HandShake = STEP_END;

				} else Met_Var.Step_HandShake = STEP_END;	
				break;
			case SEND_BAURATE:	
				Met_Var.Step_HandShake++;
				//send ACK + Baurate
				CPC_IEC62056_21_Command (CMD_ACK, NULL, 0);
				break;
			case RECEI_ENCRYPT_KEY:   //Mat khau câp 3 can phai lay Key de mã hoa Pass:16 byte DC 34 61 91 0E 9E 70 B6 E7 8F AB 3A D3 30 3A C2
				if (osSemaphoreWait(bsUART2PendingMessHandle,5000) == osOK) 
                {
                    Met_Var.Step_HandShake++;
					PosFind = Find_String_V2(&Str_RECEI_KEY, &UART1_Control.UART1_Str_Recei);
					if( PosFind >= 0)
					{
						//lay key
						for(i = 0; i < 16; i++)
						{
							CPC_KEY_ENCRYPT[i] = *(UART1_Control.UART1_Str_Recei.Data_a8 + PosFind + Str_RECEI_KEY.Length_u16 + 1 + i);
							//ma hoa Pass nêu la Pass cap 3
						}
						Reset_UART1_State();
					}else 
						Met_Var.Step_HandShake = STEP_END;
					
				} else Met_Var.Step_HandShake = STEP_END;  
				break;
			case SEND_PASSWORD:	//Send first Char
				Met_Var.Step_HandShake++;
				//Send truc tiep mat khau cap 2
				CPC_IEC62056_21_Command (CMD_SEND_PASS, (uint8_t*)&password_2[0], sizeof(password_2));
				break;
			case CHECK_ACK_2:
				if (osSemaphoreWait(bsUART2PendingMessHandle,5000) == osOK) 
                {
					Reset_UART1_State();
                    Met_Var.Count_Error = 0;
					Met_Var.Reading_ui8 = 1;
				}else Met_Var.Step_HandShake = STEP_END;
				break;
			case STEP_END:
				CPC_IEC62056_21_Command (CMD_LOGOUT, NULL, 0);
				Count_Step_End++;
				if(Count_Step_End <= 1)
					Met_Var.Step_HandShake = SEND_FIRST_CHAR;
				else
                {
                    Met_Var.Count_Error++;
					return 0;
                }
				break;				
			default:
                    return 0;
				break;		
		}
        
	}
	return 1;
}

//Nhan uart trong ngat. Co Phai thay cac ham delay bang cac hang doi queue. de check moi chuan?

uint8_t CPC_GetUART1Data(void)
{
	uint8_t	temp_recieve = 0;

	switch (UART1_Control.Mode_ui8)
	{
		case 0: // data message
			if (UART1_Control.Mess_Pending_ui8 != 1)
			{
				temp_recieve = (uint8_t)(huart1.Instance->RDR&0xFF);
				
				if((temp_recieve == 0x02) || (UART1_Control.Flag_Have_0x02))    //bat dau ghi vai buff tu 0x02
				{
					UART1_Control.Flag_Have_0x02 = 1;  //DA NHAN DUOC KI TU BAT DAU LENH
					
					*(UART1_Control.UART1_Str_Recei.Data_a8 + UART1_Control.UART1_Str_Recei.Length_u16) = temp_recieve;
					UART1_Control.UART1_Str_Recei.Length_u16++;
                    
					if (UART1_Control.Mess_Pending_ui8 == 2)  //nhan BCC
					{
						UART1_Control.Mess_Pending_ui8 = 1;
						osSemaphoreRelease(bsUART2PendingMessHandle);
					}	
					//
					if (temp_recieve == ETX) // Ki tu ket thuc
					{
						UART1_Control.Mess_Pending_ui8 = 2;
					}
		
					if (UART1_Control.UART1_Str_Recei.Length_u16 > MAX_LENGTH_BUFF_NHAN)	
							UART1_Control.UART1_Str_Recei.Length_u16 = 0;
				}
			}else
				temp_recieve = (uint8_t)(huart1.Instance->RDR&0xFF);
			
			break;
		case 1: // handshake message
			if (UART1_Control.Mess_Pending_ui8 != 1)
			{
				temp_recieve = (uint8_t)(huart1.Instance->RDR&0xFF);
				
				*(UART1_Control.UART1_Str_Recei.Data_a8 + UART1_Control.UART1_Str_Recei.Length_u16) = temp_recieve;
			    UART1_Control.UART1_Str_Recei.Length_u16++;    //bien chung
				
				switch (Met_Var.Step_HandShake)    
				{ 
					case CHECK_ACK_1:
						if (temp_recieve == 0x0A) // handshake 1
						{
							UART1_Control.Mess_Pending_ui8 = 1;
							osSemaphoreRelease(bsUART2PendingMessHandle);
						}
						break;
					case RECEI_ENCRYPT_KEY:
						if (UART1_Control.Mess_Pending_ui8 == 2)  //nhan BCC
						{
							UART1_Control.Mess_Pending_ui8 = 1;
							osSemaphoreRelease(bsUART2PendingMessHandle);
						}	
						if (temp_recieve == ETX) // Ki tu ket thuc
						{
							UART1_Control.Mess_Pending_ui8 = 2;
						}
						break;
					case CHECK_ACK_2:
						if (temp_recieve == ACK) //  - ACK
						{
							UART1_Control.Mess_Pending_ui8 = 1;
							osSemaphoreRelease(bsUART2PendingMessHandle);
						}	

						break;
					default:
						break;
				}
			}
			else
				temp_recieve = (uint8_t)(huart1.Instance->RDR&0x7F);
			break;
		default:
			break;
	}
    return 1;
}



uint8_t CPC_CheckResetReadMeter(uint32_t Timeout)
{
	// Reset neu doc sai cong to
    if ((sDCU.Status_Meter_u8 == 0) && (Check_Time_Out(sDCU.LandMark_Count_Reset_Find_Meter,600000) == TRUE)) // 10p
    {
        osDelay(Timeout); // 5p
        Read_Meter_ID_Success = CPC_Get_Meter_ID(0);
        if(Read_Meter_ID_Success != 1) // Reset MCU
        {
            __disable_irq();
            NVIC_SystemReset(); // Reset MCU	
        }
        else
            sDCU.LandMark_Count_Reset_Find_Meter = RT_Count_Systick_u32;
    }
    return 1;
}


uint8_t CPC_Check_Meter(void)
{
    // Check Error of Meter ID
	if (Read_Meter_ID_Success == 1) 
	{ 
        if(Met_Var.Count_Error >=2)
        {
            Read_Meter_ID_Success = CPC_Get_Meter_ID(0);
        }else
            sDCU.Status_Meter_u8 = 2; // Co Cong to
		
		if (Read_Meter_ID_Change == 1) 
        {
			sDCU.Status_Meter_u8 = 1;
			Read_Meter_ID_Change = 0;
		}
	} else {
		sDCU.Status_Meter_u8 = 0;	// khong co Dong ho
	}
    return 1;
} 


uint8_t Read_TSVH_CPC(uint8_t (*FuncDataHandle)(void), uint8_t Mess_Type)
{
    if (CPC_Handshake_Handle() == 1)
    {
        if(Function_Get_Stime()== 1)
        {
            Function_Get_OutStation();
            if(Function_Get_TuTi() == 1)
            {
                if(Function_Get_IntanVaue() == 1)
                {
                    Function_Get_EnergyTotal();
                    Function_Get_Tariff();
                    if(Function_Get_MAXDemand() == 1)
                    {
                      if(FuncDataHandle() == 1)
                      {
                            Init_Meter_Event_Struct();
                            if(Function_Get_Event() == 1)
                                Pack_Event_TSVH(); 
                            //them tu ti va ket thuc goi tin
                            ADD_TuTI_EndPacket(&Get_Meter_Info);
                            Push_TSVH_toQueue(Mess_Type);
                      }
                      return 1;
                    }
                }
            }
        }
    }
    return 0;
}
uint8_t Read_Historycal_CPC (uint16_t IndexStart, uint16_t IndexEnd )
{
    uint16_t Index = 0;
    uint8_t         BuffNum[20];
    truct_String    Str_Data_Write={&BuffNum[0], 0};
    uint8_t         Temp_BBC = 0;
    
    if((IndexStart < IndexEnd) || (IndexEnd == 0))  return 0;
    
    for(Index = IndexStart; Index>= IndexEnd; Index--)
    {   
        Init_Meter_Billing_Struct();
        Met_Var.Flag_Get_Chot_Ok = 0;  //hay quen
        if(Read_His_CPC_InDex(&CPC_Pack_PushData_103_Chot, Index) == 0) return 0;
        
        if(sInformation.Flag_Stop_ReadBill == 1)
        {
            sInformation.Flag_Stop_ReadBill = 0;
            return 1;
        }
    }
    if(sDCU.FlagHave_BillMes == 0)
    {
        Reset_Buff(&Get_Meter_Billing.Str_Payload);
        Write_Header_His_Push103();
        Add_TuTI_toPayload(&Get_Meter_Billing);
        //lay het data moi ghep stime Bill vao
        Reset_Buff(&Str_Data_Write);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
//        Copy_String_STime(&Str_Data_Write, sInformation.StartTime_GetBill);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
        
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
        Pack_HEXData_Frame_Uint64(&Str_Data_Write, 3, 0);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
        
        Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.PosNumqty, &Str_Data_Write);
        //
        //ETX
        *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ETX; 
        //BBC
        Temp_BBC = BBC_Cacul(Get_Meter_Billing.Str_Payload.Data_a8 + 1,Get_Meter_Billing.Str_Payload.Length_u16 - 1);
        *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = Temp_BBC;
        
        Push_Bill_toQueue(DATA_HISTORICAL);
    }
    return 1;
}
uint8_t Read_His_CPC_InDex (uint8_t (*FuncDataHandle)(void), uint16_t Numbill)
{    
    uint32_t diffTimeStampStart = 0;   //bien k dung
    
    if (CPC_Handshake_Handle() == 1)
    {
        if(Function_Get_TuTi() == 1)
        {
            if(Function_Get_Bill(Numbill)== 1)
            {
                //check time bill xem co nam trong khoang start stop k
                Epoch_to_date_time(&LastBill.sTimeRTC_LastBill, LastBill.sTime);
                
                if(Check_DiffTime(sInformation.EndTime_GetBill, LastBill.sTimeRTC_LastBill, &diffTimeStampStart) == 0)
                    return 0;
                if(Check_DiffTime(LastBill.sTimeRTC_LastBill, sInformation.StartTime_GetBill, &diffTimeStampStart) == 0)
                {
                    return 1; 
                }else
                {
                    if(FuncDataHandle() == 1)
                    {
                        //Push data to queue
                       Push_Bill_toQueue(DATA_HISTORICAL);
                       return 1;
                    } 
                }
            }
        }
    }
    return 0;
}

uint8_t Function_Get_IntanVaue (void)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
	
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Instan Value ...\r\n", 24, 1000);
	
	for(i = 0; i< MAX_PACKET_INSTANCE; i++)
	{
		//copy data set vao
		for(j = 0; j<11; j++)
			Buff_Data_Set[j] = Data_Set_Intan_1[j];
		
		Buff_Data_Set[3] = i + 0x30;    //khac nhau byte thu 4
		
		if(FunctionRead_Meter(&FunExtract_IntanValue,&Buff_Data_Set[0], 11) == 0) return 0;
        osDelay(20);
	}
	
	return 1;
}


uint8_t FunctionRead_Meter (void (*FuncExtractRawData)(uint8_t IndexPack), uint8_t* Buff_DataSet, uint8_t length_DataSet)
{
	uint8_t ByteTemp = 0;
	
	//truyên lenh doc gia tri intan: dong dien va dien ap
	UART1_Control.Mode_ui8 = 0;    //chuyen uart sang nhan data
	Reset_UART1_State();
	
	//Send Read ID
	CPC_IEC62056_21_Command (CMD_READ, Buff_DataSet, length_DataSet);
    
//    HAL_UART_Transmit(&UART_SERIAL, &Buff_DataSet[0], length_DataSet, 1000);
	
	//cat gia tri ra
	if (osSemaphoreWait(bsUART2PendingMessHandle,5000) == osOK) 
    {
		//Check BBC
		if(CPC_Check_Sum(&UART1_Control.UART1_Str_Recei) == 1)
		{
			//check byte thu 2. xem dung nhu byte dau tien cua data set khong?
			if(*(UART1_Control.UART1_Str_Recei.Data_a8 + 1) == *(Buff_DataSet))  //
			{
				//cat data o day
				if((*Buff_DataSet) == 'U')    //doc event
				{
					ByteTemp = Convert2ByteHexStringto_1Hex(Buff_DataSet + 4);
					FuncExtractRawData(ByteTemp);
				}else if(((*Buff_DataSet) == 'T') || ((*Buff_DataSet) == '^'))  //doc chot du lieu
				{
					ByteTemp = Convert2ByteHexStringto_1Hex(Buff_DataSet + 6);
					FuncExtractRawData(ByteTemp);
				}
				else
					FuncExtractRawData(*(Buff_DataSet + 3) - 0x30);
			}
			//
			return 1;
		}
		else
		{
			Reset_UART1_State();
			CPC_IEC62056_21_Command (CMD_LOGOUT, NULL, 0);
			osDelay(TIME_DELAY_ERR);
		}
	}
	else
	{
		Reset_UART1_State();
		CPC_IEC62056_21_Command (CMD_LOGOUT, NULL, 0);
		osDelay(TIME_DELAY_ERR);
	}
	return 0;
}



void FunExtract_IntanValue (uint8_t IndexPack)
{
	uint16_t length = 0;
	uint8_t j = 0;

	switch(IndexPack)
	{
		case 0:
			for(j = 0; j < 54; j++) //54 byte goi 1
			{
                Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
                length += 2;
			}
			break;
		case 1:
			for(j = 0; j < 96; j++) //96 byte goi 2
            {
                Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
                length += 2;
            }
			break;
		case 2:
            for(j = 0; j < 32; j++) //32 goi 3
            {
                Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
                length += 2;
            }
            Met_Var.Flag_GetIntan_Ok = 1;
			break;
		default:
			break;
	}
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Instan Value OK\r\n", 23, 1000);
}


//Doc giá tri sTime
uint8_t Function_Get_Stime (void)
{
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet STime ...\r\n", 17, 1000);
	return FunctionRead_Meter(&FunExtract_STime,(uint8_t*)&Data_Set_ReadsTime[0], 11);
}


void FunExtract_STime(uint8_t IndexPack)
{
	//check length nhan:
//	HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
	
	//
	Met_Var.STimeIntan.sec 		= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 3);
	Met_Var.STimeIntan.min 		= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 5);
	Met_Var.STimeIntan.hour 	= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 7);
	Met_Var.STimeIntan.date 	= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 9);
	Met_Var.STimeIntan.month 	= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 11);
	Met_Var.STimeIntan.year 	= Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + 13);
	
    Met_Var.sTime_s = HW_RTC_GetCalendarValue_Second(Met_Var.STimeIntan);
      
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet STime OK\r\n", 16, 1000);
//	PrintChar1byte(Met_Var.STimeIntan.sec);
//	PrintChar1byte(Met_Var.STimeIntan.min);
//	PrintChar1byte(Met_Var.STimeIntan.hour);
//	PrintChar1byte(Met_Var.STimeIntan.date);
//	PrintChar1byte(Met_Var.STimeIntan.month);
//	PrintChar1byte(Met_Var.STimeIntan.year);
}

uint8_t ConvertHexStringtoHex (uint8_t HexString)
{
	if(HexString > 0x39) return(HexString - 0x37);
	else return(HexString - 0x30);
}

uint8_t Convert2ByteHexStringto_1Hex (uint8_t* Buff)
{
	uint8_t ByteTemp = 0;
	
	ByteTemp = (ConvertHexStringtoHex (*Buff)) << 4;
	ByteTemp |= ConvertHexStringtoHex (*(Buff + 1));
	
	return ByteTemp;
}

//Doc giá tri Out station
uint8_t Function_Get_OutStation (void)
{
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Out Station ...\r\n", 23, 1000);
	return FunctionRead_Meter(&FunExtract_OStation,(uint8_t*)&Data_Set_ReadOStation[0], 11);
}


void FunExtract_OStation(uint8_t IndexPack)
{
	uint16_t length = 0;
	//check length nhan:
//	HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
	
	//Init buff Chua string out station meter
	Met_Var.String_OutStation.Data_a8 = &BuffStringOutStation[0];
	Reset_Buff(&Met_Var.String_OutStation);
	Met_Var.String_OutStation.Length_u16 = 0;
	
	while ((length + 3) < UART1_Control.UART1_Str_Recei.Length_u16 -3)
	{
		*(Met_Var.String_OutStation.Data_a8 + Met_Var.String_OutStation.Length_u16) = *(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
		Met_Var.String_OutStation.Length_u16++;
		length++;
	}
	
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Out Station OK\r\n", 22, 1000);
//	HAL_UART_Transmit(&UART_SERIAL, Met_Var.String_OutStation.Data_a8, Met_Var.String_OutStation.Length_u16, 1000);
}

//Doc giá tri Tu Ti
uint8_t Function_Get_TuTi (void)
{
    Init_Meter_TuTi_Struct();
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Tu Ti ...\r\n", 17, 1000);
	return FunctionRead_Meter(&FunExtract_TuTi,(uint8_t*)&Data_Set_ReadOTuTi[0], 11);
}


void FunExtract_TuTi(uint8_t IndexPack)
{
	uint16_t length = 0;
	uint8_t i = 0;
	uint8_t ByteTemp = 0;
	
	Met_Var.Tu_Primary = 0;
	Met_Var.Ti_Primary = 0;
	Met_Var.Ti_Second = 0;
	Met_Var.Tu_Second = 0;
	
	//check length nhan:
//	HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
	
	//Tu Primary  ConvertHexStringtoHex
	for(i = 0; i < 4; i++)
	{
		ByteTemp = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
		length += 2;
		Met_Var.Tu_Primary |= (ByteTemp << (8*i));
	}
	
	//Tu Second
	Met_Var.Tu_Second = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
	length += 2;
	
	//Ti Primary
	for(i = 0; i < 4; i++)
	{
		ByteTemp = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
		length += 2;
		Met_Var.Ti_Primary |= (ByteTemp << (8*i));
	}
	//Ti Second
	Met_Var.Ti_Second = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
	
    //dong goi vao Buff TuTi
    //TU Ti He so nhan		

    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Get_Meter_TuTi.Str_Payload, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Get_Meter_TuTi.Str_Payload, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = ')';
    //Tu.	
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Get_Meter_TuTi.Str_Payload, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Get_Meter_TuTi.Str_Payload, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = ')';
    //he so nhan	
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Get_Meter_TuTi.Str_Payload, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
    *(Get_Meter_TuTi.Str_Payload.Data_a8 + Get_Meter_TuTi.Str_Payload.Length_u16++) = ')';
}

//Doc giá tri Dien nang tong
uint8_t Function_Get_EnergyTotal (void)
{
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Energy total ...\r\n", 24, 1000);
	return FunctionRead_Meter(&FunExtract_EnergyTotal,(uint8_t*)&Data_Set_ReadEnergy_Intan[0], 11);
}


void FunExtract_EnergyTotal(uint8_t IndexPack)
{
	uint16_t length = 0;
	uint8_t i = 0;
    uint8_t count = 0;
	//lây lan luot cac gia tri: moi gia tri 8byte
    for(count = 0; count < 9; count++)  //9*8 = 72 byte
        for(i = 0; i < 8; i++)
        {
            Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
            length += 2;
        }
    Met_Var.Flag_Get_EnRegister_Ok = 1;
}


//doc bieu gia 
uint8_t Function_Get_Tariff (void)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
	

	for(i = 0; i< MAX_PACKET_TARIFF; i++)
	{
		//copy data set vao
		for(j = 0; j<11; j++)
			Buff_Data_Set[j] = Data_Set_ReadTariff_G1[j];
		Buff_Data_Set[3] = i + 0x30;    //khac nhau byte thu 4
		
		if(FunctionRead_Meter(&FunExtract_Tariff,&Buff_Data_Set[0], 11) == 0) return 0;
        osDelay(20);
	}
	return 1;
}


void FunExtract_Tariff (uint8_t IndexPack)
{
	switch(IndexPack)
	{
		case 0: 
			FunExtract_In1Pack_Tariff(IndexPack);
			break;
		case 1:
			FunExtract_In1Pack_Tariff(IndexPack);
			break;
		case 2:
			FunExtract_In1Pack_Tariff(IndexPack);
			break;
		case 3:
			FunExtract_In1Pack_Tariff(IndexPack);
            Met_Var.Flag_Get_Tariff_Ok = 1;
			break;
		default:
			break;
	}
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Tariff OK\r\n", 17, 1000);
}


void FunExtract_In1Pack_Tariff(uint8_t Pack)
{
	uint16_t length = 0;
	uint8_t i = 0;
     
	for(i = 0; i < 72; i++)   //8 bieu*9 = 72.   4 gói
	{
        Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] =  Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
        length += 2;
	}
}


//doc Maximun Demand 
uint8_t Function_Get_MAXDemand (void)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
	
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet MAX Demand ...\r\n", 22, 1000);
	
	for(i = 0; i< MAX_PACKET_MAXDEMAND; i++)
	{
		//copy data set vao
		for(j = 0; j<11; j++)
			Buff_Data_Set[j] = Data_Set_ReadMD_1[j];
		Buff_Data_Set[3] = i + 0x30;    //khac nhau byte thu 4
		
		if(FunctionRead_Meter(&FunExtract_MAXDemand,&Buff_Data_Set[0], 11) == 0) return 0;
        osDelay(20);
	}
	return 1;
}


void FunExtract_MAXDemand (uint8_t IndexPack)
{
	switch(IndexPack)
	{
		case 0: 
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 1:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 2:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 3:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 4:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 5:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 6:
			FunExtract_In1Pack_MaxDemand(IndexPack);
			break;
		case 7:
			FunExtract_In1Pack_MaxDemand(IndexPack);
            Met_Var.Flag_Get_MaxDemand_Ok = 1;
			break;
		default:
			break;
	}
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet MaxDemand OK\r\n", 20, 1000);
}

void FunExtract_In1Pack_MaxDemand(uint8_t Pack)
{
	uint16_t length = 0;
	uint8_t i = 0;
		
	for(i = 0; i < 37; i++) //1 goi = 1+(8 +4) *3 = 37 byte
	{
        Meter_TempBuff[Get_Meter_Info.Data_Buff_Pointer_ui16++] =  Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
        length += 2;
	}
}



//doc Event
uint8_t Function_Get_Event(void)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
	uint8_t Temp = 0;
	
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Event ...\r\n", 17, 1000);
	
	for(i = 0; i< MAX_PACKET_EVENT; i++)
	{
		//copy data set vao
		for(j = 0; j<11; j++)
			Buff_Data_Set[j] = Data_Set_Event_1[j];
		//thay 2 byte 4 5 bang Index event
		Temp = ConvertHextoAscii((i &0xF0) >> 4);
		Buff_Data_Set[4] = Temp;    //khac nhau byte thu 4
		Temp = ConvertHextoAscii(i &0x0F);
		Buff_Data_Set[5] =  Temp;    	   //khac nhau byte thu 5
		
		if(FunctionRead_Meter(&FunExtract_Event,&Buff_Data_Set[0], 11) == 0) return 0;
        osDelay(20);
	}
	return 1;
}

uint8_t ConvertHextoAscii (uint8_t Hex)
{
	if(Hex > 0x09) return (Hex + 0x37);
	else return (Hex + 0x30);
}

void FunExtract_Event (uint8_t IndexPack)
{
	switch(IndexPack)
	{
		case 0: 
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 1:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 2:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 3:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 4:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 5:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 6:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 7:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 8: 
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 9:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0A:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0B:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0C:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0D:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0E:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x0F:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x10: 
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x11:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x12:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x13:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x14:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x15:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x16:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x17:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x18: 
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x19:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x1A:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x1B:
			FunExtract_In1Pack_Event(IndexPack);
			break;
		case 0x1C:
			FunExtract_In1Pack_Event(IndexPack);
            Met_Var.Flag_Get_Event_Ok = 1;
			break;
		default:
			break;
	}
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Event OK\r\n", 16, 1000);
}

void FunExtract_In1Pack_Event(uint8_t Pack)
{
	uint16_t length = 0;
	uint8_t i = 0;
//	uint8_t j = 0;

//	HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
	
    for(i = 0; i < 13; i++) //1 byte source + 4 byte total + 4byte starttime + 4 byte stoptime = 13 byte
    {
        Meter_TempBuff[Get_Meter_Event.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
        length += 2;
    }
    
//	//lay source
//	Met_Var.Event[Pack].Source = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
//	length += 2;
//	//total 	
//    for(j = 0; j < 4; j++)
//    {
//        Met_Var.Event[Pack].Total |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*j);
//        length += 2;
//    }
//    if(Met_Var.Event[Pack].Total == 0xFFFFFFFF) Met_Var.Event[Pack].Total = 0;
//    //
//    while((length+3) < (UART1_Control.UART1_Str_Recei.Length_u16 - 3 - 2))  //tru them 2 vi stime cuoi cung 4 byte
//    {
////        for(i = 0; i < 5; i++)
////        {
//            //Starttime
//            for(j = 0; j < 4; j++)
//            {
//                 Met_Var.Event[Pack].Time.TimeStart |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*j);
//                length += 2;
//            }
//            //Stoptime
//            for(j = 0; j < 4; j++)
//            {
//                 Met_Var.Event[Pack].Time.TimeStop |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*j);
//                length += 2;
//            }
//            if(Met_Var.Event[Pack].Time.TimeStart == 0xFFFFFFFF) Met_Var.Event[Pack].Time.TimeStart = 0;
//            if(Met_Var.Event[Pack].Time.TimeStop == 0xFFFFFFFF) Met_Var.Event[Pack].Time.TimeStop = 0;
//            //Convert sang RTC luon
//            Epoch_to_date_time(& Met_Var.Event[Pack].Time.TimeStartRTC,  Met_Var.Event[Pack].Time.TimeStart);
//            Epoch_to_date_time(& Met_Var.Event[Pack].Time.TimeStopRTC,  Met_Var.Event[Pack].Time.TimeStop);
////        }   
//            break;
//    }
}




//Ham de debug
uint16_t ConvertHextoHexstring (uint8_t* BuffHex, uint16_t length, uint8_t* BuffHexString)
{
	uint8_t temp = 0;
	uint16_t i = 0;
	uint16_t LengthResult = 0;
	
	for(i = 0; i < length; i++)
	{
		temp = (*(BuffHex +i) & 0xF0) >> 4;
		*(BuffHexString + 2*i) = ConvertHextoAscii(temp);
		temp = *(BuffHex +i) & 0x0F;
		*(BuffHexString + 2*i + 1) = ConvertHextoAscii(temp);
		LengthResult += 2;
	}
	return LengthResult;
}

void PrintInteger4byte(uint32_t value)
{
//	uint8_t buff[4];
//	uint8_t LengthPrint = 0;
//	uint8_t Buff_Print[8];
//	
//	buff[0] = (uint8_t)(value >> 24);
//	buff[1] = (uint8_t)(value >> 16);
//	buff[2] = (uint8_t)(value >> 8);
//	buff[3] = (uint8_t)(value);
//	
//	LengthPrint = (uint8_t) ConvertHextoHexstring(&buff[0], 4, &Buff_Print[0]);
	
//	HAL_UART_Transmit(&UART_SERIAL, &Buff_Print[0], LengthPrint, 1000);
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "  \r\n", 4, 1000);
}

void PrintChar1byte(uint8_t value)
{
//	uint8_t Buff_Print[2];
	
//	ConvertHextoHexstring(&value, 1, &Buff_Print[0]);
	
//	HAL_UART_Transmit(&UART_SERIAL, &Buff_Print[0], 2, 1000);
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "  \r\n", 4, 1000);
}

void Print8byte(uint64_t value)
{
//	uint8_t buff[8];
//	uint8_t LengthPrint = 0;
//	uint8_t Buff_Print[16];
	
//	buff[0] = (uint8_t)(value >> 56);
//	buff[1] = (uint8_t)(value >> 48);
//	buff[2] = (uint8_t)(value >> 40);
//	buff[3] = (uint8_t)(value >> 32);
//	buff[4] = (uint8_t)(value >> 24);
//	buff[5] = (uint8_t)(value >> 16);
//	buff[6] = (uint8_t)(value >> 8);
//	buff[7] = (uint8_t)(value);
	
//	LengthPrint = (uint8_t) ConvertHextoHexstring(&buff[0], 8, &Buff_Print[0]);
	
//	HAL_UART_Transmit(&UART_SERIAL, &Buff_Print[0], LengthPrint, 1000);
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "  \r\n", 4, 1000);
}




//Doc chot du lieu

uint8_t Function_Get_Bill(uint16_t SttBill)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
	uint8_t Temp = 0;
    uint8_t TempBill = 0;
	
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet Last Bill ...\r\n", 21, 1000);
	
	for(i = 0; i< MAX_PACKET_LASTBILL; i++)
	{
		//copy data set vao
		for(j = 0; j<11; j++)
			Buff_Data_Set[j] = Data_Set_LastBill_1[j];
        
		//thay 2 byte 2 3 SttBill
        TempBill = (uint8_t) SttBill;
        Temp = ConvertHextoAscii((TempBill &0xF0) >> 4);
		Buff_Data_Set[2] = Temp;    //khac nhau byte thu 2
        Temp = ConvertHextoAscii(TempBill &0x0F);
		Buff_Data_Set[3] = Temp;    //khac nhau byte thu 3
        
        TempBill = (uint8_t) (SttBill >> 8);
        Temp = ConvertHextoAscii((TempBill &0xF0) >> 4);
		Buff_Data_Set[4] = Temp;    //khac nhau byte thu 2
        Temp = ConvertHextoAscii(TempBill &0x0F);
		Buff_Data_Set[5] = Temp;    //khac nhau byte thu 3
        
        //thay 2 byte 6 7 bang Index Pack
		Temp = ConvertHextoAscii((i &0xF0) >> 4);
		Buff_Data_Set[6] = Temp;    //khac nhau byte thu 6
		Temp = ConvertHextoAscii(i &0x0F);
		Buff_Data_Set[7] =  Temp;   //khac nhau byte thu 7
		
		if(FunctionRead_Meter(&FunExtract_LastBill,&Buff_Data_Set[0], 11) == 0) return 0;
        osDelay(20);
	}
	return 1;
}


void FunExtract_LastBill (uint8_t IndexPack)
{
	uint8_t i = 0;
	uint16_t length = 0;
	
	switch(IndexPack)
	{
		case 0: 
			//4byte time UTC. don vi giây.
//            HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
			LastBill.sTime = 0;
			for(i = 0; i < 4; i++)
			{
				LastBill.sTime |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*i);
				length += 2;
			}
			break;
		case 1:
			//lây lan luot cac gia tri: 12 dai luong. moi gia tri 8byte
			for(i = 0; i < 96; i++)
			{
				Meter_TempBuff[Get_Meter_Billing.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
				length += 2;
			}
			break;
		case 2:
			FunExtract_In1Pack_TariffLastBill(IndexPack - 2);
			break;
		case 3:
			FunExtract_In1Pack_TariffLastBill(IndexPack - 2);
			break;
		case 4:
			FunExtract_In1Pack_TariffLastBill(IndexPack - 2);
			break;
		case 5:
			FunExtract_In1Pack_TariffLastBill(IndexPack - 2);
			break;
		case 6:
			FunExtract_In1Pack_MaxDemandLastBill(IndexPack - 6);
			break;
		case 7:
			FunExtract_In1Pack_MaxDemandLastBill(IndexPack - 6);
			break;
		case 8: 
			FunExtract_In1Pack_MaxDemandLastBill(IndexPack - 6);
			break;
		case 9:
			FunExtract_In1Pack_MaxDemandLastBill(IndexPack - 6);
            Met_Var.Flag_Get_Chot_Ok = 1;
			break;
		default:
			break;
	}
}

void FunExtract_In1Pack_TariffLastBill(uint8_t Pack)
{
	uint16_t length = 0;
	uint8_t i = 0;

	for(i = 0; i < 72; i++)   //(1+8) *8) = 
	{
		Meter_TempBuff[Get_Meter_Billing.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
		length += 2;
	}
}





void FunExtract_In1Pack_MaxDemandLastBill(uint8_t Pack)
{
	uint16_t length = 0;
	uint8_t count = 0;

	//lay source
	for(count = 0; count < 74; count++)   //2 soure * (1 + (8 +4) *3)
	{
		Meter_TempBuff[Get_Meter_Billing.Data_Buff_Pointer_ui16++] = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3);
		length += 2;
	}
}


//doc bieu do phu tai

uint8_t Read_Lpf_CPC (uint16_t Index_Start, uint16_t Index_End, uint8_t mode)
{
    truct_String    Str_Data_Write={&Buff_Temp1[0], 0};
    sDCU.FlagHave_ProfMess = 0;
    
    if (CPC_Handshake_Handle() == 1)
    {
        if(Function_Get_Stime()== 1)
        {
            if(Function_Get_TuTi() == 1)
            {
                Function_Get_LoadProfile(Index_Start, Index_End, mode);
                //
                if(sDCU.FlagHave_ProfMess == 0)
                {
                    //dong goi tin rong gui len
                    Init_Meter_LProf_Struct(); 
                    //wrire header TSVH vao
                    Pack_Header_lpf_Pushdata103();
                    
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Get_Meter_LProf.Pos_Obis_Inbuff, &Str_Ob_Ti);  
                    Get_Meter_LProf.Pos_Obis_Inbuff += Str_Ob_Tu.Length_u16;
                    Get_Meter_LProf.Numqty++;
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Get_Meter_LProf.Pos_Obis_Inbuff, &Str_Ob_Tu);  
                    Get_Meter_LProf.Pos_Obis_Inbuff += Str_Ob_Ti.Length_u16;
                    Get_Meter_LProf.Numqty++;
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Get_Meter_LProf.Pos_Obis_Inbuff, &He_So_Nhan);  
                    Get_Meter_LProf.Pos_Obis_Inbuff += He_So_Nhan.Length_u16;
                    Get_Meter_LProf.Numqty++;
                    Get_Meter_LProf.Pos_Data_Inbuff = Get_Meter_LProf.Str_Payload.Length_u16;
                    
                     //TU Ti He so nhan	
                     Reset_Buff(&Str_Data_Write);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    //Tu.	
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    //he so nhan	
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Get_Meter_LProf.Pos_Data_Inbuff, &Str_Data_Write); 
                    Get_Meter_LProf.Pos_Data_Inbuff = Get_Meter_LProf.Str_Payload.Length_u16;
                    
                    Reset_Buff(&Str_Data_Write);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
            //        Copy_String_STime(&Str_Data_Write, sInformation.EndTime_GetLpf);  //stime start
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
                    //event
                    Copy_String_2(&Str_Data_Write, &Str_event_Temp);
                    //period
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t)(PeriodLpf_Min) ,0);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
                    //num chanel
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Get_Meter_LProf.Numqty, 0);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
                    
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Get_Meter_LProf.PosNumqty, &Str_Data_Write);
                    
                    Send_MessLpf_toQueue();
                }
                
                sInformation.Flag_Stop_ReadLpf = 0;
                return 1;
            }
        }
    }

    return 0;
}

uint8_t Read_Infor_Meter (void)
{    
    if (CPC_Handshake_Handle() == 1)
        if(Function_Get_Stime()== 1)
            if(Function_Get_TuTi() == 1)
            {
                //dong goi Tu TI vao Buff Ti TI
                
                Pack_PushData_103_Infor_Meter(); 
                return 1;
            } 
    return 0;
}

uint8_t Function_Get_LoadProfile(uint16_t Index_Start, uint16_t Index_End, uint8_t mode)
{
	uint8_t i = 0, j = 0;;
	uint8_t Buff_Data_Set[11];	
    uint8_t aB_DataSet_TotalPack[11];	
	uint8_t Temp = 0;
    uint16_t Index;
    uint8_t Index_U8 = 0;
    
    if((Index_Start < Index_End) || (Index_End == 0)) return 0;
    
//	HAL_UART_Transmit(&UART_SERIAL, (uint8_t*) "\r\nGet load profile ...\r\n", 24, 1000);
	//doc cau hinh cua phu tai
	if(FunctionRead_Meter(&Get_ConfigChart,(uint8_t*)&Data_Set_ReadConfigChart[0], 11) == 1)
	{
        for(Index = Index_Start; Index >= Index_End; Index--)   //doc lan luot thu tu ngay can doc
        {
            //copy data set vao
            for(j = 0; j<11; j++)
                aB_DataSet_TotalPack[j] = Data_Set_TotalPack[j];
            
            Index_U8 = (uint8_t) Index;    //lay byte thap truoc
            //Set Ngay doc Lpf vào total Pack
            Temp = ConvertHextoAscii((Index_U8 &0xF0) >> 4);
            aB_DataSet_TotalPack[2] = Temp;    
            Temp = ConvertHextoAscii(Index_U8 &0x0F);
            aB_DataSet_TotalPack[3] = Temp;    
            
            Index_U8 = (uint8_t) (Index >> 8);     //lay byte cao
            Temp = ConvertHextoAscii((Index_U8 &0xF0) >> 4);
            aB_DataSet_TotalPack[4] = Temp;    
            Temp = ConvertHextoAscii(Index_U8 &0x0F);
            aB_DataSet_TotalPack[5] = Temp;    
        
            //lay tông so Pack trong ngay
            if(FunctionRead_Meter(&Get_ToTalPack_inday,&aB_DataSet_TotalPack[0], 11) == 1)
            {
                Init_Meter_LProf_Struct();
                StrUartTemp.Length_u16 = 0;   //Reset buff chua cac byte du
                
                for(i = 1; i <= Met_Var.Loadpf.TotalPack; i++)
                {                
                    //copy data set vao
                    for(j = 0; j<11; j++)
                        Buff_Data_Set[j] = Data_Set_lpf_1[j];
                    
                    Index_U8 = (uint8_t) Index;    //lay byte thap truoc
                    //Set Ngay doc Lpf vào total Pack
                    Temp = ConvertHextoAscii((Index_U8 &0xF0) >> 4);
                    Buff_Data_Set[2] = Temp;    
                    Temp = ConvertHextoAscii(Index_U8 &0x0F);
                    Buff_Data_Set[3] = Temp;    
                    
                    Index_U8 = (uint8_t) (Index >> 8);     //lay byte cao
                    Temp = ConvertHextoAscii((Index_U8 &0xF0) >> 4);
                    Buff_Data_Set[4] = Temp;    
                    Temp = ConvertHextoAscii(Index_U8 &0x0F);
                    Buff_Data_Set[5] = Temp;   
                    
                    //thay 2 byte 6 7 bang Index Pack
                    Temp = ConvertHextoAscii((i &0xF0) >> 4);
                    Buff_Data_Set[6] = Temp;    //khac nhau byte thu 6
                    Temp = ConvertHextoAscii(i &0x0F);
                    Buff_Data_Set[7] =  Temp;    //khac nhau byte thu 7
                    

                    if(FunctionRead_Meter(&FunExtract_In1Pack_lpf_1,&Buff_Data_Set[0], 11) == 0) 
                      return 0;
                    
                    //Kiem tra xem có lenh dung doc lpf khong. Van return 1;
                    if(sInformation.Flag_Stop_ReadLpf == 1)
                    {
                        sInformation.Flag_Stop_ReadLpf = 0;
                        return 1;
                    }
                    osDelay(20);
                }
            }
            osDelay(20);
        }
	}
		
	return 1;
}


void Get_ToTalPack_inday (uint8_t pack)
{
	uint16_t length = 0;
	uint16_t i = 0;
	//2byte
	Met_Var.Loadpf.TotalPack = 0;
//    HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
    
	for(i = 0; i < 2; i++)
	{
		Met_Var.Loadpf.TotalPack |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*i);
		length += 2;
	}
}


void Get_ConfigChart (uint8_t pack)
{
	uint16_t length = 0;
	uint16_t i = 0;
	
//    HAL_UART_Transmit(&UART_SERIAL, UART1_Control.UART1_Str_Recei.Data_a8, UART1_Control.UART1_Str_Recei.Length_u16, 1000);
    
	//4 byte cofi va 2 byte chu ki tich phan
	Met_Var.Loadpf.Config_Source = 0;
	
	for(i = 0; i < 4; i++)
	{
		Met_Var.Loadpf.Config_Source |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*i);
		length += 2;
	}
	
	for(i = 0; i < 2; i++)
	{
		Met_Var.Loadpf.Period |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length + 3)) << (8*i);
		length += 2;
	}
	//Giai ma cac dai luong va period luon
	Decode_LpfConfig(Met_Var.Loadpf.Config_Source);
}


void Decode_LpfConfig (uint32_t ValueConfig)
{
	uint8_t i = 0;
	uint8_t j = 0;
	
    Met_Var.Loadpf.NumChannel = 0;
	for(i = 0; i <18; i++)
	{
		if((uint8_t)((ValueConfig >>i) & 0x00000001) == 1)
		{
			for(j = 0; j < 24; j++)
				Met_Var.Loadpf.DataLpf.Record.Data[Met_Var.Loadpf.NumChannel].Source = i;
			
			Met_Var.Loadpf.NumChannel++;
		}
	}
}

/*<STX>OBIScode(IDmeter)(starttime)(event)(period)(numchanel)(ch1)[(ch2)]<CR><LF>(ch1value*unit1)[(ch2value*unit2)]<ETX><BCC>
?	OBIScode: 99.1.0
*/

void CPC_Pack_Header_lpf_Pushdata103 (truct_String* Payload, ST_TIME_FORMAT sTime, uint32_t Event)
{
     uint16_t i = 0;
     
    //STX
    *(Payload->Data_a8 + Payload->Length_u16++) = STX;
    //obiscode Intan
    Copy_String_2(Payload, &Str_OB_LPF);
    
    //DCUID
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &sDCU.sDCU_id); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //ID Meter
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &sDCU.sMeter_id_now);   
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //Meter type
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &Str_MeterType_u8[sDCU.MeterType]);  
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //Start time
    *(Payload->Data_a8 + Payload->Length_u16++) = '('; 
    Copy_String_STime(Payload, sTime);
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    //event (0000)
    Met_Var.Pos_Eventlpf = Payload->Length_u16;  //luu vi tri lai
   
    //period
    *(Payload->Data_a8 + Payload->Length_u16++) = '('; 
    Pack_HEXData_Frame(Payload,  (Met_Var.Loadpf.DataLpf.Header.Period/60), 0);
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    //num channel
    *(Payload->Data_a8 + Payload->Length_u16++) = '('; 
    Pack_HEXData_Frame(Payload,  (Met_Var.Loadpf.NumChannel + 3), 0);
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
     //Lan luot cac obis cua channel
    for(i = 0; i<Met_Var.Loadpf.NumChannel; i++)
    {
        if(Met_Var.Loadpf.DataLpf.Record.Data[i].Source  < 5)
            Copy_String_2(Payload, &Str_Ob_lpf[Met_Var.Loadpf.DataLpf.Record.Data[i].Source]);
    }
    //Tu Ti He so nhan
    Copy_String_2(Payload, &Str_Ob_Tu); 
    Copy_String_2(Payload, &Str_Ob_Ti);  
    Copy_String_2(Payload, &He_So_Nhan);
}


/*	    //thu tu tu bit cao xuong bit thap
     Loi phan cung       Pin yeu               Ðoi ti so VT-CT	  Ðoi mat khau	
     Cau hình công to	 Thay doi thoi gian	    Cau hình moi      Ngày moi
     Mat dien	         Sai thu tu pha         Quá dòng         Quá áp    	 
     Thap áp	        Nguoc dòng dien	        Loi pha	         Mat cân bang pha 	
*/

void Get_Event_Lpf(truct_String* Str, uint8_t header_status, uint8_t Error_record)
{
    uint16_t event = 0;
//    uint8_t test = 0x30;
    uint16_t temp = 0;
    Reset_Buff(Str);

    if((Error_record&0x01) == 1)            event += 0x0001;  //mat can bang pha
    if(((Error_record >> 1) & 0x01) == 1)   event |= 0x0007; //mat ap pha a
    if(((Error_record >> 2) & 0x01) == 1)   event |= 0x0007; //mat ap pha b
    if(((Error_record >> 3) & 0x01) == 1)   event |= 0x0007; //mat ap pha c
    
    if(((Error_record >> 4) & 0x01) == 1)   event |= 0x000B; //nguoc cuc tinh pha a
    if(((Error_record >> 5) & 0x01) == 1)   event |= 0x000B; //nguoc cuc tinh pha b
    if(((Error_record >> 6) & 0x01) == 1)   event |= 0x000B; //nguoc cuc tinh pha c
    
    if(header_status == 0xF0) event|= 0x0E00;     //new date
    if(header_status == 0xF1) event|= 0x0D00;     //new config
    if(header_status == 0xF2) event|= 0x0070;     //mat dien
//    if(header_status == 0xF3) event|= 0x80;       //co dien    
    if(header_status == 0xF4) event|= 0x0B00;    // thay doi thoi gian
    if(header_status == 0xF5) event|= 0x0700;     //new config cong to
    if(header_status == 0xF6) event|= 0x0700;         //new pass
    if(header_status == 0xF7) event|= 0xD000;         // new tu ti
    
    *(Str->Data_a8 + Str->Length_u16++) = '(';
    for(uint8_t i = 0; i < 4; i++)
    {
        temp = (event >> (12- 4*i) & 0x000F);
        if(temp <=9) temp += 0x30;
        else temp += 0x37; 
        *(Str->Data_a8 + Str->Length_u16++) = temp;
    }
    *(Str->Data_a8 + Str->Length_u16++) = ')';
    
//    if(header_status == 0xF0) test= 0x31;     //new date
//    if(header_status == 0xF1) test= 0x32;     //new config
//    if(header_status == 0xF2) test= 0x33;     //mat dien
//    if(header_status == 0xF3) test= 0x34;       //co dien    
//    if(header_status == 0xF4) test= 0x35;    // thay doi thoi gian
//    if(header_status == 0xF5) test= 0x36;     //new config cong to
//    if(header_status == 0xF6) test= 0x37;         //new pass
//    if(header_status == 0xF7) test= 0x38;         // new tu ti
//    //copy event vao
//    
//    *(Str->Data_a8 + Str->Length_u16++) = '(';
//    *(Str->Data_a8 + Str->Length_u16++) = '0';
//    *(Str->Data_a8 + Str->Length_u16++) = '0';
//    *(Str->Data_a8 + Str->Length_u16++) = '0';
//    *(Str->Data_a8 + Str->Length_u16++) = test;
//    *(Str->Data_a8 + Str->Length_u16++) = ')';
       
}


void FunExtract_In1Pack_lpf_1(uint8_t Pack)
{
	uint16_t length = 0;
	uint16_t i = 0;
	uint16_t j = 0;
    uint8_t Buff_temp[20];
    truct_String Str_eventlpf = {&Buff_temp[0], 0};
    uint8_t Status = 0;
    uint8_t Flag_First_Record = 0;
    uint8_t Temp_Check = 0;

    if(Pack == Met_Var.Loadpf.TotalPack)
    {
        Met_Var.Flag_Get_lpf_Ok = 1;
    }
    
    //Neu nhu co byte du o truoc, chen vao dau data buff uart. Nhung sau 3 ki tu dau
    //dich cac byte ra phia sau: StrUartTemp.Length_u16 byte
    for(j = (UART1_Control.UART1_Str_Recei.Length_u16 - 1); j>=3; j--)
        *(UART1_Control.UART1_Str_Recei.Data_a8 + j + StrUartTemp.Length_u16) = *(UART1_Control.UART1_Str_Recei.Data_a8 + j);
    for(i = 0; i < StrUartTemp.Length_u16; i++)   //chuyen cac byte vao dau data
         *(UART1_Control.UART1_Str_Recei.Data_a8 + i + 3) = *(StrUartTemp.Data_a8 + i);
    //cong them Length Uart them phan du
    UART1_Control.UART1_Str_Recei.Length_u16 += StrUartTemp.Length_u16;
    StrUartTemp.Length_u16 = 0;  //reset lai buff temp
    
    length += 3;  //3 byte dau tien 
	//lay file header: 1byte status
    while(length < (UART1_Control.UART1_Str_Recei.Length_u16 - 3 - (2+8*Met_Var.Loadpf.NumChannel)))   
    {
        Met_Var.Loadpf.DataLpf.Header.Status = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length);
        length += 2;
        Status = Met_Var.Loadpf.DataLpf.Header.Status;
        //Reset data
        for(i = 0; i < Met_Var.Loadpf.NumChannel; i++)
            Met_Var.Loadpf.DataLpf.Record.Data[i].Value = 0;
    
        switch(Met_Var.Loadpf.DataLpf.Header.Status)
        {
            case 0xF0:  //new date
            case 0xF1:
            case 0xF2:
            case 0xF3:
            case 0xF4:
            case 0xF5:
            case 0xF6:        
            case 0xF7:
                //4byte UTC
                Met_Var.Loadpf.DataLpf.Header.UTC_Time = 0;
                for(j = 0; j < 4; j++)
                {
                    Met_Var.Loadpf.DataLpf.Header.UTC_Time |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length)) << (8*j);
                    length += 2;
                }
                //2byte Period
                Met_Var.Loadpf.DataLpf.Header.Period = 0;
                for(j = 0; j < 2; j++)
                {
                    Met_Var.Loadpf.DataLpf.Header.Period |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length)) << (8*j);
                    length += 2;
                }
                //4byte Config
                Met_Var.Loadpf.DataLpf.Header.Cofig = 0;
                for(j = 0; j < 4; j++)
                {
                    Met_Var.Loadpf.DataLpf.Header.Cofig |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length)) << (8*j);
                    length += 2;
                }
                //1byte Crc
                Met_Var.Loadpf.DataLpf.Header.Crc = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length);
                length += 2;
                if((Status == 0xF2) || (Status == 0xF4) || (Status == 0xF5) || (Status == 0xF7))  //neu la F2, F4 F5 F7 thi can lay thoi gian tron. cua khung du lieu phia truoc
                    Met_Var.Loadpf.DataLpf.Record.Stime = (Met_Var.Loadpf.DataLpf.Header.UTC_Time/Met_Var.Loadpf.DataLpf.Header.Period) *Met_Var.Loadpf.DataLpf.Header.Period;
                else  Met_Var.Loadpf.DataLpf.Record.Stime =  Met_Var.Loadpf.DataLpf.Header.UTC_Time; 
                
                break;
            case 0xFF:
                return;
            default:
                //neu vao day thi tiep cai data theo status cu
                length -= 2;   //tru de lay lai ERROR
                Met_Var.Loadpf.DataLpf.Header.Status = 0;
                
                if(Get_Meter_LProf.Flag_Start_Pack == 0)
                {
                    Met_Var.Loadpf.DataLpf.Header.Status_Before = 0;
                    Epoch_to_date_time(&Met_Var.Loadpf.DataLpf.Record.sTimeRTC, Met_Var.Loadpf.DataLpf.Record.Stime);   //stime cong them truoc de dong goi
                    Reset_Buff(&Get_Meter_LProf.Str_Payload);
                    CPC_Pack_Header_lpf_Pushdata103(&Get_Meter_LProf.Str_Payload, Met_Var.Loadpf.DataLpf.Record.sTimeRTC, 0);
                    Get_Meter_LProf.Flag_Start_Pack = 1;
                }
//                if(Flag_First_Record != 0) 
                    Met_Var.Loadpf.DataLpf.Record.Stime = (Met_Var.Loadpf.DataLpf.Record.Stime/Met_Var.Loadpf.DataLpf.Header.Period) *Met_Var.Loadpf.DataLpf.Header.Period + Met_Var.Loadpf.DataLpf.Header.Period;
                Flag_First_Record++;
        
                Met_Var.Loadpf.DataLpf.Record.Error = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length);
                length += 2;
                for(i = 0; i < Met_Var.Loadpf.NumChannel; i++)
                {
                    Met_Var.Loadpf.DataLpf.Record.Data[i].Value = 0;
                    for(j = 0; j < 4; j++)
                    {
                        Met_Var.Loadpf.DataLpf.Record.Data[i].Value |=  (Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length)) << (8*j);
                        length += 2;
                    }
                }
                Met_Var.Loadpf.DataLpf.Record.Crc = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length);
                length += 2;
                
                Met_Var.Loadpf.NumRecord++;
                //Dong goi data theo 103
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = 0x0D;
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = 0x0A;
                for(i = 0; i < Met_Var.Loadpf.NumChannel; i++)
                {
                    if(Met_Var.Loadpf.DataLpf.Record.Data[i].Source  < 5)   //Chi lay 4 dai luong dau tien
                    {
                        *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '(';
                        Pack_HEXData_Frame(&Get_Meter_LProf.Str_Payload, (int64_t)Convert_float_2int(Met_Var.Loadpf.DataLpf.Record.Data[i].Value, CPC_SCALE_LPF), CPC_SCALE_LPF);
                        *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '*';
                        Copy_String_2(&Get_Meter_LProf.Str_Payload, &Unit_Lpf[Met_Var.Loadpf.DataLpf.Record.Data[i].Source]);    //don vi
                        *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = ')';
                    }
                }
                //Tu.	
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '(';
                Pack_HEXData_Frame_Uint64(&Get_Meter_LProf.Str_Payload, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '/';
                Pack_HEXData_Frame_Uint64(&Get_Meter_LProf.Str_Payload, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = ')';
                
                //TU Ti He so nhan		
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '(';
                Pack_HEXData_Frame_Uint64(&Get_Meter_LProf.Str_Payload, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '/';
                Pack_HEXData_Frame_Uint64(&Get_Meter_LProf.Str_Payload, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = ')';
                
                //he so nhan	
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = '(';
                Pack_HEXData_Frame_Uint64(&Get_Meter_LProf.Str_Payload, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
                *(Get_Meter_LProf.Str_Payload.Data_a8 + Get_Meter_LProf.Str_Payload.Length_u16++) = ')';
                
                //check xem. neu la header tiep.
//                Temp_Check = Convert2ByteHexStringto_1Hex(UART1_Control.UART1_Str_Recei.Data_a8 + length);
//                if(Temp_Check >= 0xF0)  
//                {
                    //dung 1 byte status va 1 byte ERROR de phan tich event
                    Get_Event_Lpf (&Str_eventlpf, Met_Var.Loadpf.DataLpf.Header.Status_Before,  Met_Var.Loadpf.DataLpf.Record.Error);
                    Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Met_Var.Pos_Eventlpf, &Str_eventlpf); 
                    Send_MessLpf_toQueue();
                    Get_Meter_LProf.Flag_Start_Pack = 0;
                    Flag_First_Record = 0;   //tinh lai. de khi thoat vong while con data thi moi gui
//                }
                break;  
        }
    }
    
    Reset_Buff(&StrUartTemp);
    //Copy phan du sang 1 buff khac de. Phan du se bang: TongLength_Uart -  (Length da cat + 3byte check dau) -  3byte cuoi.
    for(i = 0; i < (UART1_Control.UART1_Str_Recei.Length_u16 - length - 3); i++)
        *(StrUartTemp.Data_a8 + StrUartTemp.Length_u16++) = *(UART1_Control.UART1_Str_Recei.Data_a8 + length + i);

//    if(Flag_First_Record > 0)    //môi frame chi 1 khung stimestamp
//    {
//        //dung 1 byte status va 1 byte ERROR de phan tich event
//        Get_Event_Lpf (&Str_eventlpf, Met_Var.Loadpf.DataLpf.Header.Status_Before,  Met_Var.Loadpf.DataLpf.Record.Error);
//        Copy_String_toTaget(&Get_Meter_LProf.Str_Payload, Met_Var.Pos_Eventlpf, &Str_eventlpf); 
//        Send_MessLpf_toQueue();
//        Get_Meter_LProf.Flag_Start_Pack = 0;
//    }
}

void CPC_Pack_Tariff_Demand(Meter_Comm_Struct* Get_Meter, uint8_t* Data_Tariff, uint8_t* Data_Maxdemand, uint8_t type)
{
    uint8_t     Count = 0;
    uint16_t    i = 0;
    uint8_t     j = 0;
    uint8_t         BuffNum[100];
    truct_String    Str_Data_Write={&BuffNum[0], 0};
    uint8_t         Soure = 0;
    uint64_t        Second = 0;
    ST_TIME_FORMAT  STimeMaxD;
    uint64_t        TempData = 0;
    
    //lay source
    for(Count = 0; Count < 32; Count++)  //32 biue gia
    {
        Reset_Buff(&Str_Data_Write);
        Soure = Data_Tariff[i++] ;
        TempData = 0;
        for(j = 0; j < 8; j++)
            TempData |=  Data_Tariff[i++] << (8*j);
        
        switch (Soure)
        {
            case 0x01:  //Active Energy plus
                if(Get_Meter->Flag_ui8 == 0)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate1_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate1_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate1);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate1.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }else if(Get_Meter->Flag_ui8 == 1)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate2_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate2_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate2);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate2.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }else if(Get_Meter->Flag_ui8 == 2)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate3_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate3_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcPlus_Rate3);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate3.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal);  
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }
                Get_Meter->Flag_ui8++;
                break;
            case 0x02:  //Active Energy Sub 
                if(Get_Meter->Flag_ui32 == 0)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate1_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcSub_Rate1_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate1);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate2.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }else if(Get_Meter->Flag_ui32 == 1)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate2_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcSub_Rate2_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate1);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate2.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }else if(Get_Meter->Flag_ui32 == 2)
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate3_chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcSub_Rate3_chot.Length_u16;
                    }else if(type == DATA_OPERATION)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_AcSub_Rate3);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_AcPlus_Rate3.Length_u16;
                    }
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //DATA
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal);  
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                }
                Get_Meter->Flag_ui32++;
                break;
            default:
                break;
        }
    }
        
    i = 0;
    for(Count = 0; Count < 8; Count++)  //8 biue gia: time va value chi lay cai dau tien
    {
        Reset_Buff(&Str_Data_Write);
        Soure = Data_Maxdemand[i++] ;
        TempData = 0;
        for(j = 0; j < 8; j++)
            TempData |=  Data_Maxdemand[i++] << (8*j);
        Second = 0;
        for(j = 0; j < 4; j++)
            Second |=  Data_Maxdemand[i++] << (8*j);
        
        switch (Soure)
        {
            case 0x01:  //Active Energy plus
                if(Get_Meter->IndexRead == 0) 
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate1_Chot);  
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate1_Chot.Length_u16;
                    }else if (type == DATA_OPERATION)  
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate1);  
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate1.Length_u16;
                    }
                }
                else if(Get_Meter->IndexRead == 1) 
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate2_Chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate2_Chot.Length_u16;
                    }else if (type == DATA_OPERATION)   
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate2);  
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate2.Length_u16;
                    }
                }
                else if(Get_Meter->IndexRead == 2) 
                {
                    if(type == DATA_HISTORICAL)
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate3_Chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate3_Chot.Length_u16;
                    }else if (type == DATA_OPERATION)   
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDeRate3);  
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDeRate3.Length_u16;
                    }
                }
                else break;
                Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                Get_Meter->Numqty ++;
                //data
                *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_MAX_DEMAND);  
                *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                Copy_String_2(&Str_Data_Write, &Unit_MAXDEMAND);
                *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                //convert time(uint32) sang stime RTC.
                Epoch_to_date_time(&STimeMaxD, Second);
                
                *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
                Copy_String_STime(&Str_Data_Write,STimeMaxD);
                *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    
                Get_Meter->IndexRead++;  //lay tam lam bien dem
                break;
            case 0x02:  //Active Energy Sub 
                if(type == DATA_HISTORICAL)
                {
                    if(Get_Meter->Mess_Step_ui8 == 0) 
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDe2Rate1_Chot);  
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDe2Rate1_Chot.Length_u16;
                    }
                    else if(Get_Meter->Mess_Step_ui8 == 1) 
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDe2Rate2_Chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDe2Rate2_Chot.Length_u16;
                    }
                    else if(Get_Meter->Mess_Step_ui8 == 2) 
                    {
                        Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Ob_MaxDe2Rate3_Chot);
                        Get_Meter->Pos_Obis_Inbuff += Str_Ob_MaxDe2Rate3_Chot.Length_u16;
                    }
                    else break;
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                    Get_Meter->Numqty ++;
                    //data
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
                    Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_MAX_DEMAND);  
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
                    Copy_String_2(&Str_Data_Write, &Unit_MAXDEMAND);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    //convert time(uint32) sang stime RTC.
                    Epoch_to_date_time(&STimeMaxD, Second);
                    
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
                    Copy_String_STime(&Str_Data_Write,STimeMaxD);
                    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
                    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
                    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
                        
                    Get_Meter_Billing.Mess_Step_ui8++;  //lay tam lam bien dem
                }
                break;
            default:
                break;
        }
        
        i += 24; //bo qua 2 value va time tiep theo
    }
}
    
//Dong goi ban tin opera theo dinh dang Push data
// - <STX>OBIScode(DCUID)(IDmeter)(timelabel)(numqty)(data1)[(data2)](data1value*unit1)[(data2value*unit2)]<ETX><BCC>
//ban tin 1 cho các gia tri tuc thoi

uint8_t Pack_PushData_103_Opera_1 (void)
{ 
    uint16_t    i = 0;
    truct_String    Str_Data_Write={&BuffRecord[0], 0};   //buff nay 200 byte khai bao chung
//    uint8_t     Temp_BBC = 0;
    uint32_t    Tem_u32 = 0;
    uint16_t    Tem_u16 = 0;
    uint64_t    Tem_u64 = 0;
    uint16_t    j = 0;
    uint16_t    count = 0;
    
    
    if((Met_Var.Flag_GetIntan_Ok == 0) || (Met_Var.Flag_Get_Tariff_Ok == 0) || (Met_Var.Flag_Get_MaxDemand_Ok ==0)|| (Met_Var.Flag_Get_EnRegister_Ok == 0))
        return 0;
    
    //STX
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = STX;
    //obiscode Intan
    Copy_String_2(&Get_Meter_Info.Str_Payload, &Str_OB_INTAN);

    //DCUID
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Info.Str_Payload, &sDCU.sDCU_id); 
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
    
    //ID Meter
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Info.Str_Payload, &sDCU.sMeter_id_now);  
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';

    //Meter type
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Info.Str_Payload, &Str_MeterType_u8[sDCU.MeterType]);  
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
    
    //Timlabel
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '('; 
    Copy_String_STime(&Get_Meter_Info.Str_Payload,Met_Var.STimeIntan);
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
    
    //numqty
    Get_Meter_Info.PosNumqty = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Pos_Obis_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    //them \r\n
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = 0x0D;
    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = 0x0A;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty = 0;
       
    //0 1 2.(dien ap A B C) 3 4 5 (dong dien A B C) 6 7 8.(tan so A B C)   
    //9 10 11 12(Goc lech A B C trung binh) .
    // 13, 14, 15 ,16  (he so cong suat A B C trung binh)
    
    //54 byte goi. 196 byte goi 2 .32 goi 3
    i = 10;  //ddau tien cua buff temp
    Reset_Buff(&Str_Data_Write);
    // Dien ap A, B C, 	    
    Copy_String_2(&Str_Data_Write, &Str_Ob_VolA);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_VolB);
    Copy_String_2(&Str_Data_Write, &Str_Ob_VolC);  
    //dong dien A, B , C
    Copy_String_2(&Str_Data_Write, &Str_Ob_CurA);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_CurB);
    Copy_String_2(&Str_Data_Write, &Str_Ob_CurC);  
    //
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 6;
    //data
    Reset_Buff(&Str_Data_Write);
    for(count = 0; count<3; count++)  //3 gia tri dien ap
    {
        Tem_u32 = 0;
        for(j = 0; j<4; j++)
            Tem_u32 |= Meter_TempBuff[i++] << (8*j);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame(&Str_Data_Write, Convert_uint_2int(Tem_u32), CPC_SCALE_VOLTAGE);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        Copy_String_2(&Str_Data_Write, &Unit_Voltage);  //don vi
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    }
    for(count = 0; count<3; count++)  //3 gia tri dong dien
    {
        Tem_u32 = 0;
        for(j = 0; j<4; j++)
            Tem_u32 |= Meter_TempBuff[i++] << (8*j);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame(&Str_Data_Write, Convert_uint_2int(Tem_u32), CPC_SCALE_CURRENT);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        Copy_String_2(&Str_Data_Write, &Unit_Current);  //don vi
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    }
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
      
    //6byte tan so tiep theo. lay 1 tan so pha a
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Ob_Freq);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Ob_Freq.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 1;
    //data
    Reset_Buff(&Str_Data_Write);
    Tem_u16 = 0;
    for(j = 0; j<2; j++)
        Tem_u16 |= Meter_TempBuff[i++] << (8*j);
    
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame(&Str_Data_Write, Convert_uint16_2int16((uint16_t)Tem_u16), CPC_SCALE_FREQ);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
    Copy_String_2(&Str_Data_Write, &Unit_Freq);    //don vi
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    
    i += 4;
    i += 16;  //16 byte goc lech pha
    //he so cong suat
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_PoFacA);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_PoFacB);
    Copy_String_2(&Str_Data_Write, &Str_Ob_PoFacC);
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 3;  
    //data
    Reset_Buff(&Str_Data_Write);
    for(count = 0; count<3; count++)  //3 gia tri Powfactor bo cai cuoi
    {
        Tem_u16 = 0;
        for(j = 0; j<2; j++)
            Tem_u16 |= Meter_TempBuff[i++] << (8*j);
        
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame(&Str_Data_Write, Convert_uint16_2int16(Tem_u16), CPC_SCALE_POW_FACTOR);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    }
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    
    i += 2;
    //goi 2:  
    //+ Công suat tác dug pha A, B, C tong:  21.7.0	41.7.0  61.7.0  1.7.0
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcPowA);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcPowB);
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcPowC); 
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcPowTo);  
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 4;  
    //data
    Reset_Buff(&Str_Data_Write);
    for(count = 0; count <4; count++)  //4 gia tri active power
    {
        Tem_u64 = 0;
        for(j = 0; j<8; j++)
            Tem_u64 |= Meter_TempBuff[i++] << (8*j);
        
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame(&Str_Data_Write, Convert_uint64_2int64(Tem_u64), CPC_SCALE_ACTIVE_POW); 
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        Copy_String_2(&Str_Data_Write, &Unit_Active_Intan);    //don vi
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    }
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    
    //Công suat phan kháng pha A, B, C, tong.  
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_RePowA);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_RePowB);
    Copy_String_2(&Str_Data_Write, &Str_Ob_RePowC);
    Copy_String_2(&Str_Data_Write, &Str_Ob_RePowTo);  
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 4; 
    //data
    Reset_Buff(&Str_Data_Write);
    for(count = 0; count <4; count++)  //4 gia tri active power
    {
        Tem_u64 = 0;
        for(j = 0; j<8; j++)
            Tem_u64 |= Meter_TempBuff[i++] << (8*j);
        
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame(&Str_Data_Write, Convert_uint64_2int64(Tem_u64), CPC_SCALE_REACTIVE_POW); 
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        Copy_String_2(&Str_Data_Write, &Unit_Reactive_Intan);    //don vi
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    }
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    
    i += 32;  //bo qua appr
    //goi 3: bo qua
    
    i = 192;  //54 byte goi 1. 96 byte goi 2 .32 goi 3. bat dau sang thanh ghi tong 72 byte
    //nang luong Importwh tong bieu 1 2 3  
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_En_ImportWh); 
    Copy_String_2(&Str_Data_Write, &Str_Ob_En_ExportWh);
    Copy_String_2(&Str_Data_Write, &Str_Ob_En_ImportVar);          
    Copy_String_2(&Str_Data_Write, &Str_Ob_En_ExportVar);
    
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    Get_Meter_Info.Numqty += 4;
    //ghi data thanh ghi tong
    Reset_Buff(&Str_Data_Write);
    for(count = 0; count < 4; count++)
    {
        Tem_u64 = 0;
        for(j = 0; j < 8; j++)
            Tem_u64 |= Meter_TempBuff[i++] << (8*j);
        //ghi data vao
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame_Uint64(&Str_Data_Write, Tem_u64, CPC_SCALE_TOTAL_ENERGY);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        if(count < 2) Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
        else Copy_String_2(&Str_Data_Write, &Unit_Reactive_EnTotal); 
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';

    }
    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
    
    i += 40;  //bo qua 5 dai luong tiep the0
    //tariff
    CPC_Pack_Tariff_Demand(&Get_Meter_Info, &Meter_TempBuff[i], &Meter_TempBuff[i+288], DATA_OPERATION);
    
//    Reset_Buff(&Str_Data_Write);
//    Copy_String_2(&Str_Data_Write, &Str_Ob_Ti);  
//    Copy_String_2(&Str_Data_Write, &Str_Ob_Tu);        
//    Copy_String_2(&Str_Data_Write, &He_So_Nhan);
//    
//    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Data_Write);
//    Get_Meter_Info.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
//    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
//    Get_Meter_Info.Numqty += 3;
//    
//    //Ti.Tu
//    Reset_Buff(&Str_Data_Write);
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
//    //he so nhan	
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
//
//    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Data_Inbuff, &Str_Data_Write);
//    Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
//    
//    //ghi numqty vao
//    Reset_Buff(&Str_Data_Write);
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
//    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Get_Meter_Info.Numqty, 0);
//    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
//    Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.PosNumqty, &Str_Data_Write);
//    
//    //ETX
//    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ETX; 
//    //BBC
//    Temp_BBC = BBC_Cacul(Get_Meter_Info.Str_Payload.Data_a8 + 1,Get_Meter_Info.Str_Payload.Length_u16 - 1);
//    *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = Temp_BBC;
        
    return 1;
}


void ADD_TuTI_EndPacket (Meter_Comm_Struct* Get_Meter)
{
    truct_String    Str_Data_Write={&BuffRecord[0], 0};   //buff nay 200 byte khai bao chung
    uint8_t     Temp_BBC = 0;
    
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_Tu);
    Copy_String_2(&Str_Data_Write, &Str_Ob_Ti);  
    Copy_String_2(&Str_Data_Write, &He_So_Nhan);
    
    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter->Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
    Get_Meter->Numqty += 3;
    
    Reset_Buff(&Str_Data_Write);
    //tu
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    //ti
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    
    //he so nhan	
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';

    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter->Pos_Data_Inbuff = Get_Meter->Str_Payload.Length_u16;
    
    //ghi numqty vao
    Reset_Buff(&Str_Data_Write);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Get_Meter->Numqty, 0);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
    Copy_String_toTaget(&Get_Meter->Str_Payload, Get_Meter->PosNumqty, &Str_Data_Write);
    
    //ETX
    *(Get_Meter->Str_Payload.Data_a8 + Get_Meter->Str_Payload.Length_u16++) = ETX; 
    //BBC
    Temp_BBC = BBC_Cacul(Get_Meter->Str_Payload.Data_a8 + 1,Get_Meter->Str_Payload.Length_u16 - 1);
    *(Get_Meter->Str_Payload.Data_a8 + Get_Meter->Str_Payload.Length_u16++) = Temp_BBC;
}
//Dóng goi ban tin chot

uint8_t CPC_Pack_PushData_103_Chot (void)  //LastBill
{ 
    uint16_t    i = 10;
    uint8_t     Temp_BBC = 0;
    uint64_t    TempData = 0;
    uint8_t     j = 0;
    uint8_t     Count = 0;
    uint8_t         BuffNum[100];
    truct_String    Str_Data_Write={&BuffNum[0], 0};

    if(Met_Var.Flag_Get_Chot_Ok == 0) 
        return 0;
    //STX
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = STX;
    //obiscode Intan
    Copy_String_2(&Get_Meter_Billing.Str_Payload, &Str_OB_CHOT);
        
    //DCUID
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Billing.Str_Payload, &sDCU.sDCU_id); 
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ')';
    
    //ID Meter
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Billing.Str_Payload, &sDCU.sMeter_id_now);  
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ')';
    
    //Meter type
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = '(';
    Copy_String_2(&Get_Meter_Billing.Str_Payload, &Str_MeterType_u8[sDCU.MeterType]);  
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ')';
    
    //Timlabel
    //convert time(uint32) sang stime RTC.
    Epoch_to_date_time(&LastBill.sTimeRTC_LastBill, LastBill.sTime);
        
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = '('; 
    Copy_String_STime(&Get_Meter_Billing.Str_Payload,LastBill.sTimeRTC_LastBill);
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ')';
    
    //numqty

    Get_Meter_Billing.PosNumqty = Get_Meter_Billing.Str_Payload.Length_u16;
    Get_Meter_Billing.Pos_Obis_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;  
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = 0x0D; 
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = 0x0A;
    Get_Meter_Billing.Pos_Data_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;
    Get_Meter_Billing.Numqty = 0;
    //them các gia tri thanh ghi dien nang tong vao  

    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcImTotal_Chot); 
    Copy_String_2(&Str_Data_Write, &Str_Ob_AcExTotal_Chot);
    Copy_String_2(&Str_Data_Write, &Str_Ob_ReImTotal_Chot);        
    Copy_String_2(&Str_Data_Write, &Str_Ob_ReExTotal_Chot);
    
    Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Billing.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Billing.Pos_Data_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;
    Get_Meter_Billing.Numqty += 4;
    //ghi data thanh ghi tong
    i = 10;
    Reset_Buff(&Str_Data_Write);
    for(Count = 0; Count < 4; Count++)
    {
        TempData = 0;
        for(j = 0; j < 8; j++)
            TempData |= Meter_TempBuff[i++] << (8*j);
        //ghi data vao
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
        Pack_HEXData_Frame_Uint64(&Str_Data_Write, TempData, CPC_SCALE_TOTAL_ENERGY);
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '*';
        if(Count < 2) Copy_String_2(&Str_Data_Write, &Unit_Active_EnTotal); 
        else Copy_String_2(&Str_Data_Write, &Unit_Reactive_EnTotal); 
        *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';

    }
    
    Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Billing.Pos_Data_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;
    //bieu gia
    
    
    i = 106; //bat dau vi tri cua bieu gia.do buff luu bat dau tu 10
    CPC_Pack_Tariff_Demand(&Get_Meter_Billing, &Meter_TempBuff[i], &Meter_TempBuff[i+288], DATA_HISTORICAL);
        
    Reset_Buff(&Str_Data_Write);
    Copy_String_2(&Str_Data_Write, &Str_Ob_Ti);  
    Copy_String_2(&Str_Data_Write, &Str_Ob_Tu);        
    Copy_String_2(&Str_Data_Write, &He_So_Nhan);
    
    Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.Pos_Obis_Inbuff, &Str_Data_Write);
    Get_Meter_Billing.Pos_Obis_Inbuff += Str_Data_Write.Length_u16;
    Get_Meter_Billing.Pos_Data_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;
    Get_Meter_Billing.Numqty += 3;
    
    //Ti.Tu
    Reset_Buff(&Str_Data_Write);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    //
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    
    //he so nhan	
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';

    Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.Pos_Data_Inbuff, &Str_Data_Write);
    Get_Meter_Billing.Pos_Data_Inbuff = Get_Meter_Billing.Str_Payload.Length_u16;
    
    //ghi numqty vao
    Reset_Buff(&Str_Data_Write);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Get_Meter_Billing.Numqty, 0);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')'; 
    Copy_String_toTaget(&Get_Meter_Billing.Str_Payload, Get_Meter_Billing.PosNumqty, &Str_Data_Write);

    //ETX
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = ETX; 
    //BBC
    Temp_BBC = BBC_Cacul(Get_Meter_Billing.Str_Payload.Data_a8 + 1,Get_Meter_Billing.Str_Payload.Length_u16 - 1);
    *(Get_Meter_Billing.Str_Payload.Data_a8 + Get_Meter_Billing.Str_Payload.Length_u16++) = Temp_BBC;
    
    return 1;
}


//Dong goi ban tin Event theo 103. lay event phai lay stime truoc.
uint8_t Pack_PushData_103_Event (truct_String* Payload)  
{
    uint8_t         Temp_BBC = 0;
    uint16_t        i = 10;
    uint8_t         Buff_Temp[30];
    truct_String    Str_Data_Write = {&Buff_Temp[0], 0};
    uint8_t         Soure_temp = 0;
    uint32_t        Total = 0;
    uint32_t        TimeStart = 0;
    uint32_t        TimeStop = 0;
    uint8_t         j = 0;
    ST_TIME_FORMAT		TimeStopRTC;
    ST_TIME_FORMAT		TimeStartRTC;
    
    Reset_Buff(Payload);
    
    //STX
    *(Payload->Data_a8 + Payload->Length_u16++) = STX;
    //obiscode Intan
    Copy_String_2(Payload, &Str_OB_EVENT);
        
    //DCUID
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &sDCU.sDCU_id); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //ID Meter
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &sDCU.sMeter_id_now); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //Meter type
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Copy_String_2(Payload, &Str_MeterType_u8[sDCU.MeterType]);  
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //Timlabel
    *(Payload->Data_a8 + Payload->Length_u16++) = '('; 
    Copy_String_STime(Payload,Met_Var.STimeIntan);
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    Get_Meter_Event.PosNumqty = Payload->Length_u16;

    Get_Meter_Event.Pos_Obis_Inbuff = Payload->Length_u16;
    
    *(Payload->Data_a8 + Payload->Length_u16++) = 0x0D; 
    *(Payload->Data_a8 + Payload->Length_u16++) = 0x0A;
    Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
    //sau do la obis va data
    
    while(i < Get_Meter_Event.Data_Buff_Pointer_ui16)
    {
    	//lay source
        Soure_temp = Meter_TempBuff[i++];
        //total 
        Total = 0;
        for(j = 0; j < 4; j++)
            Total |=  Meter_TempBuff[i++] << (8*j);
        if(Total == 0xFFFFFFFF) Total = 0;
        //Starttime
        TimeStart = 0;
        for(j = 0; j < 4; j++)
             TimeStart |=  Meter_TempBuff[i++] << (8*j);
        //Stoptime
        TimeStop = 0;
        for(j = 0; j < 4; j++)
             TimeStop |=  Meter_TempBuff[i++] << (8*j);
        if(TimeStart == 0xFFFFFFFF) TimeStart = 0;
        if(TimeStop == 0xFFFFFFFF) TimeStop = 0;
        //Convert sang RTC luon
        Epoch_to_date_time(&TimeStartRTC,  TimeStart);
        Epoch_to_date_time(&TimeStopRTC,  TimeStop);

        
        if(Str_Ob_Event[Soure_temp].StartCountOB.Data_a8 != NULL)
        {
            //ghi obis count vao
            Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StartCountOB);
            Get_Meter_Event.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StartCountOB.Length_u16;
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
            Get_Meter_Event.Numqty++;
            //data
            *(Payload->Data_a8 + Payload->Length_u16++) = '('; 
            Pack_HEXData_Frame_Uint64(Payload, (uint64_t) Total, 0); 
            *(Payload->Data_a8 + Payload->Length_u16++) = ')';
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
        }
        //time start
        if(Str_Ob_Event[Soure_temp].StartTimeOB.Data_a8 != NULL)
        {
            //ghi obis count vao
            Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StartTimeOB);
            Get_Meter_Event.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StartTimeOB.Length_u16;
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
            Get_Meter_Event.Numqty++;
            //data
            *(Payload->Data_a8 + Payload->Length_u16++) = '(';
            Copy_String_STime(Payload, TimeStartRTC);
            *(Payload->Data_a8 + Payload->Length_u16++) = ')';
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
        }
            
        //time stop
        if(Str_Ob_Event[Soure_temp].StopTimeOB.Data_a8 != NULL)
        {
            //ghi obis count vao
            Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StopTimeOB);
            Get_Meter_Event.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StopTimeOB.Length_u16;
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
            Get_Meter_Event.Numqty++;
            //data
            *(Payload->Data_a8 + Payload->Length_u16++) = '(';
            Copy_String_STime(Payload, TimeStopRTC);
            *(Payload->Data_a8 + Payload->Length_u16++) = ')';
            Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
        } 
    }
    
    //them TU Ti
    
    Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &Str_Ob_Tu); 
    Get_Meter_Event.Pos_Obis_Inbuff += Str_Ob_Tu.Length_u16;
    Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &Str_Ob_Ti);  
    Get_Meter_Event.Pos_Obis_Inbuff += Str_Ob_Ti.Length_u16;
    Copy_String_toTaget(Payload, Get_Meter_Event.Pos_Obis_Inbuff, &He_So_Nhan);  
    Get_Meter_Event.Pos_Obis_Inbuff += He_So_Nhan.Length_u16;
    Get_Meter_Event.Pos_Data_Inbuff = Payload->Length_u16;
    Get_Meter_Event.Numqty += 3;
    
    //Ti.		
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(Payload, (uint64_t) Met_Var.Ti_Primary, CPC_SCALE_TU_TI); 
    *(Payload->Data_a8 + Payload->Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(Payload, (uint64_t) Met_Var.Ti_Second, CPC_SCALE_TU_TI); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //Tu.	
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(Payload, (uint64_t) Met_Var.Tu_Primary, CPC_SCALE_TU_TI);
    *(Payload->Data_a8 + Payload->Length_u16++) = '/';
    Pack_HEXData_Frame_Uint64(Payload, (uint64_t) Met_Var.Tu_Second, CPC_SCALE_TU_TI); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //he so nhan	
    *(Payload->Data_a8 + Payload->Length_u16++) = '(';
    Pack_HEXData_Frame_Uint64(Payload, (uint64_t) sDCU.He_So_Nhan, CPC_SCALE_HE_SO_NHAN); 
    *(Payload->Data_a8 + Payload->Length_u16++) = ')';
    
    //ghi numqty vao
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = '('; 
    Pack_HEXData_Frame_Uint64(&Str_Data_Write, (uint64_t) Get_Meter_Event.Numqty, 0);
    *(Str_Data_Write.Data_a8 + Str_Data_Write.Length_u16++) = ')';
    
    Copy_String_toTaget(Payload, Get_Meter_Event.PosNumqty, &Str_Data_Write); 
    
    //ETX
    *(Payload->Data_a8 + Payload->Length_u16++) = ETX; 
    //BBC
    Temp_BBC = BBC_Cacul(Payload->Data_a8 + 1,Payload->Length_u16 - 1);
    *(Payload->Data_a8 + Payload->Length_u16++) = Temp_BBC;
    return 1;
}

//chi lay cac event TSVH
uint8_t Pack_Event_TSVH (void)  
{
    uint16_t        i = 10;
    uint8_t         Soure_temp = 0;
    uint32_t        Total = 0;
    uint32_t        TimeStart = 0;
    uint32_t        TimeStop = 0;
    uint8_t         j = 0;
    ST_TIME_FORMAT		TimeStopRTC;
    ST_TIME_FORMAT		TimeStartRTC;
        
    while(i < Get_Meter_Event.Data_Buff_Pointer_ui16)
    {
    	//lay source
        Soure_temp = Meter_TempBuff[i++];
        if(((Soure_temp >= 1) && (Soure_temp <= 3)) || (Soure_temp == 0x14) || (Soure_temp == 0x15))
        {
            //total 
            Total = 0;
            for(j = 0; j < 4; j++)
                Total |=  Meter_TempBuff[i++] << (8*j);
            if(Total == 0xFFFFFFFF) Total = 0;
            //Starttime
            TimeStart = 0;
            for(j = 0; j < 4; j++)
                 TimeStart |=  Meter_TempBuff[i++] << (8*j);
            //Stoptime
            TimeStop = 0;
            for(j = 0; j < 4; j++)
                 TimeStop |=  Meter_TempBuff[i++] << (8*j);
            if(TimeStart == 0xFFFFFFFF) TimeStart = 0;
            if(TimeStop == 0xFFFFFFFF) TimeStop = 0;
            //Convert sang RTC luon
            Epoch_to_date_time(&TimeStartRTC,  TimeStart);
            Epoch_to_date_time(&TimeStopRTC,  TimeStop);

            if(Str_Ob_Event[Soure_temp].StartCountOB.Data_a8 != NULL)
            {
                //ghi obis count vao
                Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StartCountOB);
                Get_Meter_Info.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StartCountOB.Length_u16;
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
                Get_Meter_Info.Numqty++;
                //data
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '('; 
                Pack_HEXData_Frame_Uint64(&Get_Meter_Info.Str_Payload, (uint64_t) Total, 0); 
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
            }
            //time start
            if(Str_Ob_Event[Soure_temp].StartTimeOB.Data_a8 != NULL)
            {
                //ghi obis count vao
                Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StartTimeOB);
                Get_Meter_Info.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StartTimeOB.Length_u16;
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
                Get_Meter_Info.Numqty++;
                //data
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '(';
                Copy_String_STime(&Get_Meter_Info.Str_Payload, TimeStartRTC);
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
            }
                
            //time stop
            if(Str_Ob_Event[Soure_temp].StopTimeOB.Data_a8 != NULL)
            {
                //ghi obis count vao
                Copy_String_toTaget(&Get_Meter_Info.Str_Payload, Get_Meter_Info.Pos_Obis_Inbuff, &Str_Ob_Event[Soure_temp].StopTimeOB);
                Get_Meter_Info.Pos_Obis_Inbuff += Str_Ob_Event[Soure_temp].StopTimeOB.Length_u16;
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
                Get_Meter_Info.Numqty++;
                //data
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = '(';
                Copy_String_STime(&Get_Meter_Info.Str_Payload, TimeStopRTC);
                *(Get_Meter_Info.Str_Payload.Data_a8 + Get_Meter_Info.Str_Payload.Length_u16++) = ')';
                Get_Meter_Info.Pos_Data_Inbuff = Get_Meter_Info.Str_Payload.Length_u16;
            } 
        }else i+= 12;
    }
    return 1;
}

uint8_t CPC_ReadMeter_Event (void)
{
    uint16_t i = 0;
    uint32_t temp = 0;
    
    if (CPC_Handshake_Handle() == 1)
    {
        if(Function_Get_Stime()== 1)
        {
            if(Function_Get_TuTi() == 1)
            {
                if(Function_Get_Event() == 1)
                {
                    //dong goi event
                    Pack_PushData_103_Event(&Get_Meter_Event.Str_Payload);
                    //send to queue
                    //Them length trong phan luu flash
                    for(i = 0; i < Get_Meter_Event.Str_Payload.Length_u16; i++)
                        *(Get_Meter_Event.Str_Payload.Data_a8 + Get_Meter_Event.Str_Payload.Length_u16 + 1 - i) = *(Get_Meter_Event.Str_Payload.Data_a8 + Get_Meter_Event.Str_Payload.Length_u16 - i - 1);
                    
                    Get_Meter_Event.Str_Payload.Length_u16 += 2;
                    *(Get_Meter_Event.Str_Payload.Data_a8)     = (uint8_t) ((Get_Meter_Event.Str_Payload.Length_u16 + 1) >> 8) ;
                    *(Get_Meter_Event.Str_Payload.Data_a8 + 1) = (uint8_t) (Get_Meter_Event.Str_Payload.Length_u16 + 1) ;
                    
                    //Generate checksum byte
                    for (i=0;i<Get_Meter_Event.Str_Payload.Length_u16;i++)
                        temp += MeterEventDataBuff[i];
                    
                    temp = temp & 0x000000FF;
                    
                     *(Get_Meter_Event.Str_Payload.Data_a8 + Get_Meter_Event.Str_Payload.Length_u16) = (uint8_t)temp;

                    Queue_Meter_Event.Mess_Direct_ui8 = 1;
                    Queue_Meter_Event.Mess_Status_ui8 = 0;
                    Queue_Meter_Event.Mess_Type_ui8 = DATA_EVEN_METER;
                    Queue_Meter_Event.str_Flash.Length_u16 = Get_Meter_Event.Str_Payload.Length_u16 - 2;
                    Queue_Meter_Event.str_Flash.Data_a8 = &MeterEventDataBuff[2];
                    
                    xQueueSend(qMeter_SIM900Handle,(void *)&ptrQueue_Meter_Event,100);
                    if (osSemaphoreWait(bsMLProfMessSentHandle,20000) != osOK)
                        return 0;	
                    return 1;
                }
            }
        }
    }
    return 0;
}



